{% load form_tags %}
<form method="post" action="{% url 'cases:device_update' case.pk device.pk %}?next={% url 'extractions:case_extractions' case.pk %}" class="ajax-form" novalidate>
    {% csrf_token %}
    
    <!-- Campo hidden obrigatório device_category - usando o campo do formulário Django -->
    {{ form.device_category.as_hidden }}
    
    {% if is_extractor_editing %}
    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Edição como Extrator:</strong> Você pode atualizar informações do dispositivo descobertas durante a extração.
    </div>
    {% endif %}
    
    <!-- Informações Básicas do Dispositivo -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-mobile-alt me-2"></i>
                Identificação do Dispositivo
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-12">
                    {{ form.device_model|form_label_class }}
                    {{ form.device_model }}
                    {{ form.device_model.errors }}
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <div class="form-check form-switch form-label">
                        {{ form.is_imei_unknown }}
                        <label class="form-check-label" for="{{ form.is_imei_unknown.id_for_label }}">
                            {{ form.is_imei_unknown.label }}
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    {{ form.imei_01 }}
                    {{ form.imei_01.errors }}
                </div>

                <div class="col-md-3">
                    {{ form.imei_02 }}
                    {{ form.imei_02.errors }}
                </div>

                <div class="col-md-3">
                    {{ form.imei_03 }}
                    {{ form.imei_03.errors }}
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    {{ form.internal_storage|form_label_class }}
                    {{ form.internal_storage }}
                </div>
            </div>
        </div>
    </div>

    <!-- Status do Dispositivo -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Status e Segurança
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="form-check form-switch form-label">
                        {{ form.is_turned_on }}
                        <label class="form-check-label" for="{{ form.is_turned_on.id_for_label }}">
                            {{ form.is_turned_on.label }}
                        </label>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="form-check form-switch form-label">
                        {{ form.is_locked }}
                        <label class="form-check-label" for="{{ form.is_locked.id_for_label }}">
                            {{ form.is_locked.label }}
                        </label>
                    </div>
                </div>
                
                <div class="col-md-3">
                    {{ form.password_type|form_label_class }}
                    {{ form.password_type }}
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch form-label">
                        {{ form.is_password_known }}
                        <label class="form-check-label" for="{{ form.is_password_known.id_for_label }}">
                            {{ form.is_password_known.label }}
                        </label>
                    </div>
                    <div id="password_field">{{ form.password }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações Adicionais -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="card-title mb-0">
                <i class="fas fa-sticky-note me-2"></i>
                Informações Adicionais
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-12">
                    <label for="{{ form.additional_info.id_for_label }}" class="form-label">
                        {{ form.additional_info.label }}
                    </label>
                    {{ form.additional_info }}
                    {% if form.additional_info.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.additional_info.errors }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>
            Cancelar
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>
            Salvar Alterações
        </button>
    </div>
</form>

<script>
// Função para inicializar Select2 quando o modal for aberto
(function() {
    const modalId = 'editDeviceModal{{ device.pk }}';
    const selectId = '{{ form.device_model.id_for_label }}';
    
    function initializeSelect2() {
        const selectElement = $('#' + selectId);
        
        if (selectElement.length === 0) {
            return;
        }
        
        // Destrói Select2 se já existir
        if (selectElement.hasClass('select2-hidden-accessible')) {
            selectElement.select2('destroy');
        }
        
        // Inicializa Select2 para device_model
        selectElement.select2({
            theme: 'bootstrap-5',
            language: {
                noResults: function() {
                    return "Nenhum resultado encontrado";
                },
                searching: function() {
                    return "Buscando...";
                }
            },
            placeholder: 'Digite para pesquisar o modelo do dispositivo...',
            allowClear: true,
            width: '100%',
            minimumInputLength: 0,
            closeOnSelect: true,
            dropdownParent: $('#' + modalId)
        });
    }
    
    // Inicializa quando o DOM estiver pronto
    $(document).ready(function() {
        // Aguarda um pouco para garantir que o elemento existe
        setTimeout(initializeSelect2, 100);
        
        // Re-inicializa quando o modal for mostrado
        $('#' + modalId).on('shown.bs.modal', function() {
            setTimeout(initializeSelect2, 200);
        });
        
        // Função para habilitar/desabilitar campos condicionais
        function toggleField(checkboxId, fieldId) {
            const checkbox = document.getElementById(checkboxId);
            const field = document.getElementById(fieldId);
            
            if (checkbox && field) {
                let input = field.querySelector('input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]), textarea, select');
                
                if (!input) {
                    const allInputs = field.querySelectorAll('input, textarea, select');
                    for (let i = 0; i < allInputs.length; i++) {
                        const elem = allInputs[i];
                        const type = elem.type ? elem.type.toLowerCase() : '';
                        if (type !== 'checkbox' && type !== 'radio' && type !== 'hidden') {
                            input = elem;
                            break;
                        }
                    }
                }
                
                let previousState = checkbox.checked;
                
                function updateFieldState() {
                    const isChecked = checkbox.checked;
                    
                    if (input) {
                        input.disabled = !isChecked;
                        
                        if (isChecked) {
                            input.classList.remove('bg-light');
                            field.style.opacity = '1';
                            if (!previousState && isChecked) {
                                setTimeout(function() {
                                    if (input && !input.disabled) {
                                        try {
                                            input.focus();
                                        } catch(e) {}
                                    }
                                }, 50);
                            }
                        } else {
                            input.classList.add('bg-light');
                            field.style.opacity = '0.6';
                        }
                        
                        previousState = isChecked;
                    }
                }
                
                updateFieldState();
                checkbox.addEventListener('change', updateFieldState);
            }
        }
        
        // Configurar campos condicionais
        toggleField('{{ form.is_password_known.id_for_label }}', 'password_field');
        
        // Configurar campos de IMEI
        function toggleMultipleFields(checkboxId, fieldIds, invertLogic) {
            const checkbox = document.getElementById(checkboxId);
            invertLogic = invertLogic || false;
            
            if (checkbox && Array.isArray(fieldIds) && fieldIds.length > 0) {
                const inputs = [];
                
                fieldIds.forEach(function(fieldId) {
                    const input = document.getElementById(fieldId);
                    if (input) {
                        inputs.push(input);
                    }
                });
                
                if (inputs.length > 0) {
                    let previousState = checkbox.checked;
                    
                    function updateFieldsState() {
                        const isChecked = checkbox.checked;
                        const shouldEnable = invertLogic ? !isChecked : isChecked;
                        
                        inputs.forEach(function(input) {
                            input.disabled = !shouldEnable;
                            
                            if (shouldEnable) {
                                input.classList.remove('bg-light');
                                input.style.opacity = '1';
                            } else {
                                input.classList.add('bg-light');
                                input.style.opacity = '0.6';
                            }
                        });
                        
                        if (previousState !== isChecked && shouldEnable && inputs.length > 0) {
                            setTimeout(function() {
                                if (inputs[0] && !inputs[0].disabled) {
                                    try {
                                        inputs[0].focus();
                                    } catch(e) {}
                                }
                            }, 50);
                        }
                        
                        previousState = isChecked;
                    }
                    
                    updateFieldsState();
                    checkbox.addEventListener('change', updateFieldsState);
                }
            }
        }
        
        toggleMultipleFields('{{ form.is_imei_unknown.id_for_label }}', [
            '{{ form.imei_01.id_for_label }}',
            '{{ form.imei_02.id_for_label }}',
            '{{ form.imei_03.id_for_label }}'
        ], true);
    });
})();
</script>

