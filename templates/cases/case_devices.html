{% extends '_global/layout/base.html' %}
{% load static %}
{% load form_tags %}

{% block page_title %}
<i class="fas {{ page_icon }} text-primary me-2"></i>
{{ page_title }}
{% endblock page_title %}

{% block page_description %}
Visualize os dispositivos e informações do processo
{% endblock page_description %}

{% block page_actions %}
<a href="{% if request.GET.next %}{{ request.GET.next }}{% else %}{% url 'cases:list' %}{% endif %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Voltar
</a>
{% endblock page_actions %}

{% block content %}
<div class="container-fluid py-4">
    {% include 'cases/includes/case_detail_include.html' with case=case %}

    <!-- Formulário de Dispositivo -->
    <div class="row mt-4">
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" id="deviceFormTitle">
                        {% if editing_device_id %}
                            <i class="fas fa-edit me-2"></i>
                            Editar Dispositivo
                        {% else %}
                            <i class="fas fa-plus me-2"></i>
                            Adicionar Dispositivo
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                    <form id="deviceForm" method="post" action="{% if editing_device_id %}{% url 'cases:device_update' case_pk=case.pk pk=editing_device_id %}?from=devices{% else %}{% url 'cases:device_create' case_pk=case.pk %}?from=devices{% endif %}" novalidate>
                        {% csrf_token %}
                        <input type="hidden" id="deviceId" name="device_id" value="{% if editing_device_id %}{{ editing_device_id }}{% endif %}">
                        
                        <!-- Informações Básicas do Dispositivo -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-mobile-alt me-2"></i>
                                Identificação do Dispositivo
                            </h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    {{ device_form.device_category|form_label_class }}
                                    {{ device_form.device_category }}
                                    {{ device_form.device_category.errors }}
                                </div>
                                <div class="col-md-7">
                                    {{ device_form.device_model|form_label_class }}
                                    {{ device_form.device_model }}
                                    {{ device_form.device_model.errors }}
                                </div>
                                <div class="col-md-2">
                                    {{ device_form.color|form_label_class }}
                                    {{ device_form.color }}
                                    {{ device_form.color.errors }}
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.is_imei_unknown }}
                                        <label class="form-check-label" for="{{ device_form.is_imei_unknown.id_for_label }}">
                                            {{ device_form.is_imei_unknown.label }}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ device_form.imei_01|form_label_class }}
                                    {{ device_form.imei_01 }}
                                    {{ device_form.imei_01.errors }}
                                </div>
                                <div class="col-md-3">
                                    {{ device_form.imei_02|form_label_class }}
                                    {{ device_form.imei_02 }}
                                    {{ device_form.imei_02.errors }}
                                </div>
                                <div class="col-md-3">
                                    {{ device_form.imei_03|form_label_class }}
                                    {{ device_form.imei_03 }}
                                    {{ device_form.imei_03.errors }}
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    {{ device_form.owner_name|form_label_class }}
                                    {{ device_form.owner_name }}
                                    {{ device_form.owner_name.errors }}
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.is_sealed }}
                                        <label class="form-check-label" for="{{ device_form.is_sealed.id_for_label }}">
                                            {{ device_form.is_sealed.label }}
                                        </label>
                                    </div>
                                    <div id="security_seal_field">{{ device_form.security_seal }}</div>
                                </div>
                                <div class="col-md-3">
                                    {{ device_form.internal_storage|form_label_class }}
                                    {{ device_form.internal_storage }}
                                    {{ device_form.internal_storage.errors }}
                                </div>
                            </div>
                        </div>

                        <!-- Status e Segurança -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Status e Segurança
                            </h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.is_turned_on }}
                                        <label class="form-check-label" for="{{ device_form.is_turned_on.id_for_label }}">
                                            {{ device_form.is_turned_on.label }}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.is_locked }}
                                        <label class="form-check-label" for="{{ device_form.is_locked.id_for_label }}">
                                            {{ device_form.is_locked.label }}
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ device_form.password_type|form_label_class }}
                                    {{ device_form.password_type }}
                                    {{ device_form.password_type.errors }}
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.is_password_known }}
                                        <label class="form-check-label" for="{{ device_form.is_password_known.id_for_label }}">
                                            {{ device_form.is_password_known.label }}
                                        </label>
                                    </div>
                                    <div id="password_field">{{ device_form.password }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Condição Física -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-tools me-2"></i>
                                Condição Física
                            </h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.is_damaged }}
                                        <label class="form-check-label" for="{{ device_form.is_damaged.id_for_label }}">
                                            {{ device_form.is_damaged.label }}
                                        </label>
                                    </div>
                                    <div id="damage_description_field">{{ device_form.damage_description }}</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch form-label">
                                        <div id="has_fluids_field">{{ device_form.has_fluids }}</div>
                                        <label class="form-check-label" for="{{ device_form.has_fluids.id_for_label }}">
                                            {{ device_form.has_fluids.label }}
                                        </label>
                                    </div>
                                    <div id="fluids_description_field">{{ device_form.fluids_description }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Acessórios -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-sim-card me-2"></i>
                                Acessórios
                            </h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.has_sim_card }}
                                        <label class="form-check-label" for="{{ device_form.has_sim_card.id_for_label }}">
                                            {{ device_form.has_sim_card.label }}
                                        </label>
                                    </div>
                                    <div id="sim_card_info_field">{{ device_form.sim_card_info }}</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.has_memory_card }}
                                        <label class="form-check-label" for="{{ device_form.has_memory_card.id_for_label }}">
                                            {{ device_form.has_memory_card.label }}
                                        </label>
                                    </div>
                                    <div id="memory_card_info_field">{{ device_form.memory_card_info }}</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch form-label">
                                        {{ device_form.has_other_accessories }}
                                        <label class="form-check-label" for="{{ device_form.has_other_accessories.id_for_label }}">
                                            {{ device_form.has_other_accessories.label }}
                                        </label>
                                    </div>
                                    <div id="other_accessories_info_field">{{ device_form.other_accessories_info }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Informações Adicionais -->
                        <div class="mb-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-sticky-note me-2"></i>
                                Informações Adicionais
                            </h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    {{ device_form.additional_info|form_label_class }}
                                    {{ device_form.additional_info }}
                                    {{ device_form.additional_info.errors }}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <div id="editModeButtons" style="{% if editing_device_id %}display: block;{% else %}display: none;{% endif %}">
                                <button type="submit" class="btn btn-primary me-2" id="submitBtn">
                                    <i class="fas fa-save me-2"></i>
                                    <span id="submitBtnText">Salvar Alterações</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetDeviceForm()">
                                    <i class="fas fa-eraser me-2"></i>
                                    Limpar
                                </button>
                            </div>
                            <div id="createModeButtons" style="{% if editing_device_id %}display: none;{% else %}display: block;{% endif %}">
                                <button type="submit" class="btn btn-primary" id="submitBtnCreate">
                                    <i class="fas fa-save me-2"></i>
                                    Salvar Dispositivo
                                </button>
                            </div>
                            <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="{% if editing_device_id %}display: inline-block;{% else %}display: none;{% endif %}" onclick="resetDeviceForm()">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-mobile-alt me-2"></i>
                        Dispositivos do Processo
                    </h5>
                </div>
                <div class="card-body">
                    {% if devices %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Categoria</th>
                                    <th width="20%">Modelo</th>
                                    <th width="10%">Cor</th>
                                    <th width="15%">IMEI</th>
                                    <th width="15%">Proprietário</th>
                                    <th width="10%">Armazenamento</th>
                                    <th width="15%" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr>
                                    <td>
                                        {% if device.device_category %}
                                            <strong>{{ device.device_category.name }}</strong>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.device_model %}
                                            <strong>{{ device.device_model.brand.name }}</strong><br>
                                            <small class="text-muted">{{ device.device_model.name }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ device.color|default:"-" }}
                                    </td>
                                    <td>
                                        {% if device.is_imei_unknown %}
                                            <span class="badge bg-warning">Desconhecido</span>
                                        {% else %}
                                            {% if device.imei_01 %}
                                                <small>{{ device.imei_01 }}</small>
                                                {% if device.imei_02 %}
                                                    <br><small class="text-muted">{{ device.imei_02 }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ device.owner_name|default:"-" }}
                                    </td>
                                    <td>
                                        {% if device.internal_storage %}
                                            {{ device.internal_storage }} GB
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" 
                                                    class="btn btn-outline-primary edit-device-btn" 
                                                    title="Editar"
                                                    data-device-id="{{ device.pk }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-danger delete-device-btn" 
                                                    title="Excluir"
                                                    data-device-id="{{ device.pk }}"
                                                    data-device-category="{% if device.device_category %}{{ device.device_category.name }}{% else %}-{% endif %}"
                                                    data-device-model="{% if device.device_model %}{{ device.device_model.brand.name }} {{ device.device_model.name }}{% else %}-{% endif %}"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteDeviceModal">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-mobile-alt fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum dispositivo cadastrado.</p>
                        <small class="text-muted">Adicione dispositivos ao processo para iniciar as extrações.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Modal de Exclusão de Dispositivo -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-labelledby="deleteDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteDeviceModalLabel">
                    <i class="fas fa-trash me-2"></i>
                    Excluir Dispositivo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção!</strong> Esta ação não pode ser desfeita.
                </div>

                <p class="mb-3">Você tem certeza que deseja excluir o dispositivo:</p>

                <div class="card mb-3">
                    <div class="card-body">
                        <dl class="row mb-0" id="deleteDeviceInfo">
                            <dt class="col-sm-4">Categoria:</dt>
                            <dd class="col-sm-8" id="deleteDeviceCategory">-</dd>

                            <dt class="col-sm-4">Modelo:</dt>
                            <dd class="col-sm-8" id="deleteDeviceModel">-</dd>

                            <dt class="col-sm-4">Processo:</dt>
                            <dd class="col-sm-8">
                                <strong>{{ case.number|default:"Rascunho" }}</strong>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form id="deleteDeviceForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        Confirmar Exclusão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa Select2 no formulário
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('#deviceForm select').select2({
            theme: 'bootstrap-5',
            language: {
                noResults: function() {
                    return "Nenhum resultado encontrado";
                },
                searching: function() {
                    return "Buscando...";
                }
            },
            width: '100%'
        });
    }
    
    // Função para habilitar/desabilitar campos condicionais
    function toggleField(checkboxId, fieldId) {
        const checkbox = document.getElementById(checkboxId);
        const field = document.getElementById(fieldId);
        
        if (checkbox && field) {
            let input = field.querySelector('input:not([type="hidden"]):not([type="checkbox"]):not([type="radio"]), textarea, select');
            
            if (!input) {
                const allInputs = field.querySelectorAll('input, textarea, select');
                for (let i = 0; i < allInputs.length; i++) {
                    const elem = allInputs[i];
                    const type = elem.type ? elem.type.toLowerCase() : '';
                    if (type !== 'checkbox' && type !== 'radio' && type !== 'hidden') {
                        input = elem;
                        break;
                    }
                }
            }
            
            if (!input) {
                const allElements = field.querySelectorAll('*');
                for (let i = 0; i < allElements.length; i++) {
                    const elem = allElements[i];
                    if ((elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA' || elem.tagName === 'SELECT') && 
                        elem.id !== checkboxId) {
                        const type = elem.type ? elem.type.toLowerCase() : '';
                        if (type !== 'checkbox' && type !== 'radio' && type !== 'hidden') {
                            input = elem;
                            break;
                        }
                    }
                }
            }
            
            let previousState = checkbox.checked;
            
            function updateFieldState() {
                const isChecked = checkbox.checked;
                
                if (input) {
                    input.disabled = !isChecked;
                    
                    if (isChecked) {
                        input.classList.remove('bg-light');
                        field.style.opacity = '1';
                        if (!previousState && isChecked) {
                            setTimeout(function() {
                                if (input && !input.disabled) {
                                    try {
                                        input.focus();
                                    } catch(e) {}
                                }
                            }, 50);
                        }
                    } else {
                        input.classList.add('bg-light');
                        field.style.opacity = '0.6';
                    }
                    
                    previousState = isChecked;
                }
            }
            
            updateFieldState();
            checkbox.addEventListener('change', updateFieldState);
        }
    }
    
    // Função para habilitar/desabilitar múltiplos campos condicionais
    function toggleMultipleFields(checkboxId, fieldIds, invertLogic) {
        const checkbox = document.getElementById(checkboxId);
        invertLogic = invertLogic || false;
        
        if (checkbox && Array.isArray(fieldIds) && fieldIds.length > 0) {
            const inputs = [];
            
            fieldIds.forEach(function(fieldId) {
                const input = document.getElementById(fieldId);
                if (input) {
                    inputs.push(input);
                }
            });
            
            if (inputs.length > 0) {
                let previousState = checkbox.checked;
                
                function updateFieldsState() {
                    const isChecked = checkbox.checked;
                    const shouldEnable = invertLogic ? !isChecked : isChecked;
                    
                    inputs.forEach(function(input) {
                        input.disabled = !shouldEnable;
                        
                        if (shouldEnable) {
                            input.classList.remove('bg-light');
                            input.style.opacity = '1';
                        } else {
                            input.classList.add('bg-light');
                            input.style.opacity = '0.6';
                        }
                    });
                    
                    if (previousState !== isChecked && shouldEnable && inputs.length > 0) {
                        setTimeout(function() {
                            if (inputs[0] && !inputs[0].disabled) {
                                try {
                                    inputs[0].focus();
                                } catch(e) {}
                            }
                        }, 50);
                    }
                    
                    previousState = isChecked;
                }
                
                updateFieldsState();
                checkbox.addEventListener('change', updateFieldsState);
            }
        }
    }
    
    // Configurar campos condicionais
    toggleField('{{ device_form.is_sealed.id_for_label }}', 'security_seal_field');
    toggleField('{{ device_form.is_password_known.id_for_label }}', 'password_field');
    toggleField('{{ device_form.is_damaged.id_for_label }}', 'damage_description_field');
    toggleField('{{ device_form.has_fluids.id_for_label }}', 'fluids_description_field');
    toggleField('{{ device_form.has_sim_card.id_for_label }}', 'sim_card_info_field');
    toggleField('{{ device_form.has_memory_card.id_for_label }}', 'memory_card_info_field');
    toggleField('{{ device_form.has_other_accessories.id_for_label }}', 'other_accessories_info_field');
    
    // Configurar campos de IMEI (múltiplos campos controlados por um checkbox)
    toggleMultipleFields('{{ device_form.is_imei_unknown.id_for_label }}', [
        '{{ device_form.imei_01.id_for_label }}',
        '{{ device_form.imei_02.id_for_label }}',
        '{{ device_form.imei_03.id_for_label }}'
    ], true);
    
    // ===== EDIÇÃO DE DISPOSITIVOS =====
    const deviceForm = document.getElementById('deviceForm');
    const deviceIdInput = document.getElementById('deviceId');
    const formTitle = document.getElementById('deviceFormTitle');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const submitBtnCreate = document.getElementById('submitBtnCreate');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editModeButtons = document.getElementById('editModeButtons');
    const createModeButtons = document.getElementById('createModeButtons');
    const editButtons = document.querySelectorAll('.edit-device-btn');
    
    // Função para resetar o formulário para modo de criação
    window.resetDeviceForm = function() {
        deviceForm.reset();
        deviceIdInput.value = '';
        deviceForm.action = '{% url "cases:device_create" case_pk=case.pk %}?from=devices';
        formTitle.innerHTML = '<i class="fas fa-plus me-2"></i>Adicionar Dispositivo';
        cancelEditBtn.style.display = 'none';
        editModeButtons.style.display = 'none';
        createModeButtons.style.display = 'block';
        
        // Limpa o Select2
        if (typeof $ !== 'undefined' && $.fn.select2) {
            $('#deviceForm select').val(null).trigger('change');
        }
        
        // Reseta todos os checkboxes e campos condicionais
        const checkboxes = deviceForm.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = false;
            const event = new Event('change');
            cb.dispatchEvent(event);
        });
    };
    
    // Função para carregar dados do dispositivo
    function loadDeviceData(deviceId) {
        fetch('{% url "cases:device_detail" case_pk=case.pk pk=0 %}'.replace('0', deviceId), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            // Preenche o formulário com os dados
            deviceIdInput.value = data.id;
            deviceForm.action = '{% url "cases:device_update" case_pk=case.pk pk=0 %}?from=devices'.replace('0', data.id);
            
            // Preenche os campos
            if (data.device_category) {
                $('#deviceForm select[name="device_category"]').val(data.device_category).trigger('change');
            } else {
                $('#deviceForm select[name="device_category"]').val(null).trigger('change');
            }
            
            if (data.device_model) {
                $('#deviceForm select[name="device_model"]').val(data.device_model).trigger('change');
            } else {
                $('#deviceForm select[name="device_model"]').val(null).trigger('change');
            }
            
            $('#deviceForm input[name="color"]').val(data.color);
            $('#deviceForm input[name="internal_storage"]').val(data.internal_storage);
            $('#deviceForm input[name="owner_name"]').val(data.owner_name);
            
            // IMEI
            const isImeiUnknownCheckbox = document.getElementById('{{ device_form.is_imei_unknown.id_for_label }}');
            if (isImeiUnknownCheckbox) {
                isImeiUnknownCheckbox.checked = data.is_imei_unknown;
                isImeiUnknownCheckbox.dispatchEvent(new Event('change'));
            }
            
            $('#deviceForm input[name="imei_01"]').val(data.imei_01);
            $('#deviceForm input[name="imei_02"]').val(data.imei_02);
            $('#deviceForm input[name="imei_03"]').val(data.imei_03);
            
            // Status e Segurança
            const isTurnedOnCheckbox = document.getElementById('{{ device_form.is_turned_on.id_for_label }}');
            if (isTurnedOnCheckbox) isTurnedOnCheckbox.checked = data.is_turned_on;
            
            const isLockedCheckbox = document.getElementById('{{ device_form.is_locked.id_for_label }}');
            if (isLockedCheckbox) isLockedCheckbox.checked = data.is_locked;
            
            if (data.password_type) {
                $('#deviceForm select[name="password_type"]').val(data.password_type).trigger('change');
            }
            
            const isPasswordKnownCheckbox = document.getElementById('{{ device_form.is_password_known.id_for_label }}');
            if (isPasswordKnownCheckbox) {
                isPasswordKnownCheckbox.checked = data.is_password_known;
                isPasswordKnownCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="password"]').val(data.password);
            
            // Condição Física
            const isDamagedCheckbox = document.getElementById('{{ device_form.is_damaged.id_for_label }}');
            if (isDamagedCheckbox) {
                isDamagedCheckbox.checked = data.is_damaged;
                isDamagedCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="damage_description"]').val(data.damage_description);
            
            const hasFluidsCheckbox = document.getElementById('{{ device_form.has_fluids.id_for_label }}');
            if (hasFluidsCheckbox) {
                hasFluidsCheckbox.checked = data.has_fluids;
                hasFluidsCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="fluids_description"]').val(data.fluids_description);
            
            // Acessórios
            const hasSimCardCheckbox = document.getElementById('{{ device_form.has_sim_card.id_for_label }}');
            if (hasSimCardCheckbox) {
                hasSimCardCheckbox.checked = data.has_sim_card;
                hasSimCardCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="sim_card_info"]').val(data.sim_card_info);
            
            const hasMemoryCardCheckbox = document.getElementById('{{ device_form.has_memory_card.id_for_label }}');
            if (hasMemoryCardCheckbox) {
                hasMemoryCardCheckbox.checked = data.has_memory_card;
                hasMemoryCardCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="memory_card_info"]').val(data.memory_card_info);
            
            const hasOtherAccessoriesCheckbox = document.getElementById('{{ device_form.has_other_accessories.id_for_label }}');
            if (hasOtherAccessoriesCheckbox) {
                hasOtherAccessoriesCheckbox.checked = data.has_other_accessories;
                hasOtherAccessoriesCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="other_accessories_info"]').val(data.other_accessories_info);
            
            // Lacre
            const isSealedCheckbox = document.getElementById('{{ device_form.is_sealed.id_for_label }}');
            if (isSealedCheckbox) {
                isSealedCheckbox.checked = data.is_sealed;
                isSealedCheckbox.dispatchEvent(new Event('change'));
            }
            $('#deviceForm input[name="security_seal"]').val(data.security_seal);
            
            // Informações Adicionais
            $('#deviceForm textarea[name="additional_info"]').val(data.additional_info);
            
            // Atualiza o título e botões
            formTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Dispositivo';
            submitBtnText.textContent = 'Salvar Alterações';
            cancelEditBtn.style.display = 'inline-block';
            editModeButtons.style.display = 'block';
            createModeButtons.style.display = 'none';
            
            // Scroll suave até o formulário
            deviceForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Erro ao carregar dispositivo:', error);
            alert('Erro ao carregar dados do dispositivo. Tente novamente.');
        });
    }
    
    // Adiciona listener para cada botão de editar
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const deviceId = this.getAttribute('data-device-id');
            loadDeviceData(deviceId);
        });
    });
    
    // Se houver erros de validação e estiver editando, carrega os dados
    {% if editing_device_id %}
    loadDeviceData({{ editing_device_id }});
    // Preenche os dados do formulário com os valores submetidos
    {% if form_data %}
    {% if form_data.device_category %}
    setTimeout(function() {
        $('#deviceForm select[name="device_category"]').val('{{ form_data.device_category }}').trigger('change');
    }, 500);
    {% endif %}
    {% if form_data.device_model %}
    setTimeout(function() {
        $('#deviceForm select[name="device_model"]').val('{{ form_data.device_model }}').trigger('change');
    }, 500);
    {% endif %}
    $('#deviceForm input[name="color"]').val('{{ form_data.color|default:"" }}');
    $('#deviceForm input[name="internal_storage"]').val('{{ form_data.internal_storage|default:"" }}');
    $('#deviceForm input[name="owner_name"]').val('{{ form_data.owner_name|default:"" }}');
    $('#deviceForm input[name="imei_01"]').val('{{ form_data.imei_01|default:"" }}');
    $('#deviceForm input[name="imei_02"]').val('{{ form_data.imei_02|default:"" }}');
    $('#deviceForm input[name="imei_03"]').val('{{ form_data.imei_03|default:"" }}');
    $('#deviceForm input[name="password"]').val('{{ form_data.password|default:"" }}');
    $('#deviceForm input[name="damage_description"]').val('{{ form_data.damage_description|default:"" }}');
    $('#deviceForm input[name="fluids_description"]').val('{{ form_data.fluids_description|default:"" }}');
    $('#deviceForm input[name="sim_card_info"]').val('{{ form_data.sim_card_info|default:"" }}');
    $('#deviceForm input[name="memory_card_info"]').val('{{ form_data.memory_card_info|default:"" }}');
    $('#deviceForm input[name="other_accessories_info"]').val('{{ form_data.other_accessories_info|default:"" }}');
    $('#deviceForm input[name="security_seal"]').val('{{ form_data.security_seal|default:"" }}');
    $('#deviceForm textarea[name="additional_info"]').val('{{ form_data.additional_info|default:"" }}');
    
    // Atualiza checkboxes
    {% if form_data.is_imei_unknown %}
    const isImeiUnknownCheckbox = document.getElementById('{{ device_form.is_imei_unknown.id_for_label }}');
    if (isImeiUnknownCheckbox) {
        isImeiUnknownCheckbox.checked = true;
        isImeiUnknownCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.is_turned_on %}
    document.getElementById('{{ device_form.is_turned_on.id_for_label }}').checked = true;
    {% endif %}
    {% if form_data.is_locked %}
    document.getElementById('{{ device_form.is_locked.id_for_label }}').checked = true;
    {% endif %}
    {% if form_data.is_password_known %}
    const isPasswordKnownCheckbox = document.getElementById('{{ device_form.is_password_known.id_for_label }}');
    if (isPasswordKnownCheckbox) {
        isPasswordKnownCheckbox.checked = true;
        isPasswordKnownCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.is_damaged %}
    const isDamagedCheckbox = document.getElementById('{{ device_form.is_damaged.id_for_label }}');
    if (isDamagedCheckbox) {
        isDamagedCheckbox.checked = true;
        isDamagedCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.has_fluids %}
    const hasFluidsCheckbox = document.getElementById('{{ device_form.has_fluids.id_for_label }}');
    if (hasFluidsCheckbox) {
        hasFluidsCheckbox.checked = true;
        hasFluidsCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.has_sim_card %}
    const hasSimCardCheckbox = document.getElementById('{{ device_form.has_sim_card.id_for_label }}');
    if (hasSimCardCheckbox) {
        hasSimCardCheckbox.checked = true;
        hasSimCardCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.has_memory_card %}
    const hasMemoryCardCheckbox = document.getElementById('{{ device_form.has_memory_card.id_for_label }}');
    if (hasMemoryCardCheckbox) {
        hasMemoryCardCheckbox.checked = true;
        hasMemoryCardCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.has_other_accessories %}
    const hasOtherAccessoriesCheckbox = document.getElementById('{{ device_form.has_other_accessories.id_for_label }}');
    if (hasOtherAccessoriesCheckbox) {
        hasOtherAccessoriesCheckbox.checked = true;
        hasOtherAccessoriesCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.is_sealed %}
    const isSealedCheckbox = document.getElementById('{{ device_form.is_sealed.id_for_label }}');
    if (isSealedCheckbox) {
        isSealedCheckbox.checked = true;
        isSealedCheckbox.dispatchEvent(new Event('change'));
    }
    {% endif %}
    {% if form_data.password_type %}
    setTimeout(function() {
        $('#deviceForm select[name="password_type"]').val('{{ form_data.password_type }}').trigger('change');
    }, 500);
    {% endif %}
    {% endif %}
    {% endif %}
    
    // Se houver erros de validação, mostra mensagem e scroll até o formulário
    {% if form_errors %}
    setTimeout(function() {
        deviceForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Adiciona classe de erro nos campos com erro
        {% for field, errors in form_errors.items %}
        const {{ field }}Field = document.querySelector('[name="{{ field }}"]');
        if ({{ field }}Field) {
            {{ field }}Field.classList.add('is-invalid');
        }
        {% endfor %}
    }, 300);
    {% endif %}
    
    // ===== EXCLUSÃO DE DISPOSITIVOS =====
    const deleteDeviceModal = document.getElementById('deleteDeviceModal');
    const deleteDeviceForm = document.getElementById('deleteDeviceForm');
    const deleteButtons = document.querySelectorAll('.delete-device-btn');
    let currentDeleteDeviceId = null;
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            currentDeleteDeviceId = this.getAttribute('data-device-id');
            const category = this.getAttribute('data-device-category');
            const model = this.getAttribute('data-device-model');
            
            // Preenche as informações no modal
            document.getElementById('deleteDeviceCategory').textContent = category;
            document.getElementById('deleteDeviceModel').textContent = model;
            
            // Atualiza a action do form
            deleteDeviceForm.action = '{% url "cases:device_delete" case_pk=case.pk pk=0 %}?from=devices'.replace('0', currentDeleteDeviceId);
        });
    });
    
    // Submete o formulário de exclusão via AJAX
    deleteDeviceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        
        // Desabilita o botão e mostra loading
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Excluindo...';
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            const contentType = response.headers.get('content-type') || '';
            
            if (contentType.includes('application/json')) {
                return response.json();
            }
            
            if (response.status === 200 || response.status === 302 || response.ok) {
                return response.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        return { success: true, message: 'Dispositivo excluído com sucesso!' };
                    }
                });
            }
            
            if (response.status >= 400) {
                return response.text().then(text => {
                    try {
                        const jsonData = JSON.parse(text);
                        return jsonData;
                    } catch (e) {
                        if (text.includes('alert-danger') || text.includes('Erro')) {
                            throw new Error('Erro ao excluir dispositivo');
                        }
                        return { success: true, message: 'Dispositivo excluído com sucesso!' };
                    }
                });
            }
            
            return { success: true, message: 'Dispositivo excluído com sucesso!' };
        })
        .then(data => {
            if (data && data.success === false) {
                throw new Error(data.error || 'Erro ao excluir dispositivo');
            }
            
            if (data && data.success === true) {
                if (typeof window.ToastSystem !== 'undefined' && window.ToastSystem.success) {
                    window.ToastSystem.success(data.message || 'Dispositivo excluído com sucesso!');
                } else if (typeof showToast !== 'undefined') {
                    showToast(data.message || 'Dispositivo excluído com sucesso!', 'success');
                }
                
                const modal = bootstrap.Modal.getInstance(deleteDeviceModal);
                if (modal) {
                    modal.hide();
                }
                
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                return;
            }
            
            const modal = bootstrap.Modal.getInstance(deleteDeviceModal);
            if (modal) {
                modal.hide();
            }
            window.location.reload();
        })
        .catch(error => {
            console.error('Erro ao excluir dispositivo:', error);
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
            alert('Erro ao excluir dispositivo: ' + (error.message || 'Tente novamente.'));
        });
    });
});
</script>
{% endblock %}
