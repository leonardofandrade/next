{% extends '_global/layout/base.html' %}
{% load static %}

{% block title %}Extrato de Distribuições - Next{% endblock %}

{% block page_title %}
    <i class="fas fa-chart-line me-2"></i>
    Extrato de Distribuições
{% endblock %}

{% block page_description %}
    Análise completa das distribuições de solicitações por unidade de extração
{% endblock %}

{% block content %}

<div class="row">
    <!-- Filtros -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Filtros de Análise
                </h5>
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="row g-3 mb-3">
                        <div class="col-md-2">
                            <label for="year" class="form-label">Ano</label>
                            <select name="year" id="year" class="form-select">
                                <option value="">Todos os anos</option>
                                {% for year in filter_options.years %}
                                <option value="{{ year }}" {% if filters.year == year %}selected{% endif %}>{{ year }}</option>
                                {% empty %}
                                <option value="" disabled>Sem anos disponíveis</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="start_date" class="form-label">Data Início</label>
                            <input type="date" name="start_date" id="start_date" class="form-control" 
                                value="{{ filters.start_date|default:'' }}">
                        </div>
                        
                        <div class="col-md-2">
                            <label for="end_date" class="form-label">Data Fim</label>
                            <input type="date" name="end_date" id="end_date" class="form-control" 
                                value="{{ filters.end_date|default:'' }}">
                        </div>
                        
                        <div class="col-md-3">
                            <label for="extraction_unit" class="form-label">Unidade de Extração</label>
                            <select name="extraction_unit" id="extraction_unit" class="form-select">
                                <option value="">Todas as unidades</option>
                                {% for unit in filter_options.extraction_units %}
                                <option value="{{ unit.id }}" {% if filters.extraction_unit == unit.id %}selected{% endif %}>
                                    {{ unit.acronym }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select name="status" id="status" class="form-select">
                                <option value="">Todos os status</option>
                                {% for status_key, status_label in filter_options.status_choices %}
                                <option value="{{ status_key }}" {% if filters.status == status_key %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>
                            Filtrar
                        </button>
                        <a href="{% url 'requisitions:distribution_report' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>
                            Limpar
                        </a>
                        {% if show_results %}
                        <a href="{% url 'requisitions:distribution_report_print' %}?{{ request.GET.urlencode }}" 
                           class="btn btn-success" target="_blank">
                            <i class="fas fa-print me-1"></i>
                            Versão para Impressão
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Estado inicial sem filtros -->
    {% if not show_results %}
    <div class="col-12 mb-4">
        <div class="card border-dashed">
            <div class="card-body text-center text-muted py-5">
                <i class="fas fa-filter fa-3x mb-3"></i>
                <p class="mb-1">Use os filtros acima para gerar o extrato.</p>
                <small>Selecione pelo menos um filtro e clique em Filtrar.</small>
            </div>
        </div>
    </div>
    {% else %}

    
    <!-- Gráficos -->
    <!-- Resumo por Unidade de Extração (mover para a mesma linha do resumo por status) -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-building me-2"></i>
                    Resumo por Unidade de Extração
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Unidade</th>
                                <th class="text-center">Solic.</th>
                                <th class="text-center">Disp.</th>
                                <th class="text-center">Eficiência</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for unit_data in report_data.summary_by_unit %}
                            <tr>
                                <td>
                                    <strong>{% if unit_data.unit.acronym %}{{ unit_data.unit.acronym }}{% else %}{{ unit_data.unit.name }}{% endif %}</strong>
                                    {% if unit_data.unit.acronym %}
                                        <br><small class="text-muted">{{ unit_data.unit.name }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ unit_data.total_requests }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ unit_data.total_devices }}</span>
                                </td>
                                <td class="text-center">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if unit_data.efficiency_score >= 80 %}bg-success{% elif unit_data.efficiency_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ unit_data.efficiency_score }}%"
                                             aria-valuenow="{{ unit_data.efficiency_score }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ unit_data.efficiency_score }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Nenhuma unidade de extração encontrada.
                                </td>
                            </tr>
                            {% endfor %}
                            <!-- Linha de Totais -->
                            {% if report_data.summary_by_unit %}
                            <tr class="table-dark fw-bold">
                                <td>
                                    <i class="fas fa-calculator me-2"></i>
                                    <strong>TOTAIS</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary fs-6">
                                        {{ report_data.statistics.total_requests|default:0 }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info fs-6">
                                        {{ report_data.statistics.total_devices|default:0 }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary fs-6">
                                        Média Geral
                                    </span>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Gráfico Pie: Dispositivos por Unidade -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Dispositivos por Unidade
                </h5>
            </div>
            <div class="card-body">
                {% if report_data.chart_data.unit_devices_distribution %}
                <div style="position: relative; height: 400px;">
                    <canvas id="unitDevicesDistributionChart"></canvas>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-microchip fa-3x mb-3"></i>
                    <p>Nenhum dado disponível para exibir o gráfico</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Top 10 Unidades Solicitantes - Gráfico -->
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Top 10 Unidades Solicitantes
                </h5>
            </div>
            <div class="card-body">
                {% if report_data.chart_data.top_requesting_units %}
                <div style="position: relative; height: 400px;">
                    <canvas id="topRequestingUnitsChart"></canvas>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-trophy fa-3x mb-3"></i>
                    <p>Nenhum dado disponível para exibir o gráfico</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Barra de Ordenação -->
    {% comment %} <div class="col-12">
        {% include '_global/layout/includes/ordering_bar.html' %}
        
    </div> {% endcomment %}
    <!-- Lista de Solicitações -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Solicitações Encontradas 
                </h5>
            </div>
            <div class="card-body p-0">
                {% if report_data.requests_list %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 80px;"><i class="fas fa-hashtag me-1"></i>ID</th>
                                <th><i class="fas fa-building-shield me-1"></i>Solicitante</th>
                                <th><i class="fas fa-calendar-alt me-1"></i>Data</th>
                                <th><i class="fas fa-list-check me-1"></i>Procedimentos</th>
                                <th class="text-start"><i class="fas fa-mobile-alt me-1"></i>Quantidade</th>
                                <th class="text-start"><i class="fas fa-bars-progress me-1"></i>Status</th>
                                <th><i class="fas fa-microscope me-1"></i>Distribuída Para</th>
                                <th class="text-center" style="width: 120px;"><i class="fas fa-ellipsis-v me-1"></i>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request_item in report_data.requests_list %}
                            <tr>
                                <td class="text-center">
                                    <strong class="text-primary">#{{ request_item.id }}</strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">{{ request_item.requester_agency_unit__acronym|default:request_item.requester_agency_unit__name }}</div>
                                            {% if request_item.requester_agency_unit__acronym %}
                                                <small class="text-muted">{{ request_item.requester_agency_unit__name }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-medium">{{ request_item.requested_at|date:"d/m/Y H:i" }}</div>
                                </td>                        
                                <td>
                                    <div class="fw-medium" title="{{ request_item.request_procedures|default:'N/A' }}">
                                        {{ request_item.request_procedures|default:'N/A' }}
                                    </div>
                                </td>
                                <td class="text-start">
                                    <span class="badge bg-info fw-medium fs-6">
                                        {{ request_item.requested_device_amount }}&nbsp;dispositivo{{ request_item.requested_device_amount|pluralize }}
                                    </span>
                                </td>
                                <td class="text-start">
                                    <span class="badge bg-{{ request_item.get_status_color }}">
                                        {{ request_item.get_status_display }}
                                    </span>

                                    <p class="small text-muted mb-0 text-start">{{ request_item.requested_at|timesince }}</p>
                                </td>
                                <td>
                                    {% if request_item.extraction_unit__name %}
                                        <div class="d-flex align-items-center">
                                            <span class="fw-medium">{{ request_item.extraction_unit__acronym|default:request_item.extraction_unit__name }}</span>
                                        </div>
                                        {% if request_item.extraction_unit__acronym %}
                                            <small class="text-muted">{{ request_item.extraction_unit__name }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small text-danger fw-medium">                                    
                                            Não atribuída
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'requisitions:detail' request_item.id %}?next={% url 'requisitions:distribution_report' %}" 
                                        class="btn btn-outline-primary" title="Visualizar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                        <a href="{% url 'requisitions:update' request_item.id %}?next={% url 'requisitions:distribution_report' %}" 
                                        class="btn btn-outline-secondary" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Paginação -->
                {% include '_global/layout/includes/pagination.html' with page_obj=report_data.page_obj is_paginated=report_data.is_paginated %}
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma solicitação encontrada</h5>
                    <p class="text-muted">
                        Não há solicitações que correspondam aos filtros aplicados.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Pass data to JavaScript using pre-serialized JSON to handle datetimes
window.distributionReportData = (function() {
    try {
        var payload = {{ chart_data_json|default:'{}'|safe }};
        return {
            unitDistribution: payload.unit_distribution || [],
            unitDevicesDistribution: payload.unit_devices_distribution || [],
            statusDistribution: payload.status_distribution || [],
            monthlyTrend: payload.monthly_trend || [],
            topRequestingUnits: payload.top_requesting_units || []
        };
    } catch (e) {
        console.error('Failed to parse chart data JSON', e);
        return { unitDistribution: [], unitDevicesDistribution: [], statusDistribution: [], monthlyTrend: [] };
    }
})();

// Debug: Log the data
console.log('Distribution Report Data:', window.distributionReportData);
console.log('Unit Distribution:', window.distributionReportData.unitDistribution);
console.log('Status Distribution:', window.distributionReportData.statusDistribution);
console.log('Chart.js available:', typeof Chart !== 'undefined');

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initDistributionCharts();
});

function initDistributionCharts() {
    console.log('Initializing distribution charts...');
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    console.log('Chart.js is available');
    
    // Unit Devices Distribution Chart (devices per unit) - Pie Chart
    const unitDevicesCtx = document.getElementById('unitDevicesDistributionChart');
    if (unitDevicesCtx && window.distributionReportData && window.distributionReportData.unitDevicesDistribution && window.distributionReportData.unitDevicesDistribution.length > 0) {
        try {
            new Chart(unitDevicesCtx, {
                type: 'pie',
                data: {
                    labels: window.distributionReportData.unitDevicesDistribution.map(function(item) {
                        return (item.extraction_unit__acronym || item.extraction_unit__name || 'Unidade');
                    }),
                    datasets: [{
                        data: window.distributionReportData.unitDevicesDistribution.map(function(item) {
                            return item.devices || 0;
                        }),
                        backgroundColor: [
                            'rgba(13, 110, 253, 0.8)',
                            'rgba(25, 135, 84, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(108, 117, 125, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(13, 202, 240, 0.8)',
                            'rgba(253, 126, 20, 0.8)',
                            'rgba(32, 201, 151, 0.8)',
                            'rgba(233, 84, 85, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Dispositivos por Unidade'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating unit devices distribution chart:', error);
        }
    }
    
    
    // Top 10 Requesting Units Chart
    const topRequestingCtx = document.getElementById('topRequestingUnitsChart');
    console.log('Top requesting units chart canvas:', topRequestingCtx);
    
    if (topRequestingCtx && window.distributionReportData && window.distributionReportData.topRequestingUnits && window.distributionReportData.topRequestingUnits.length > 0) {
        console.log('Creating top requesting units chart with data:', window.distributionReportData.topRequestingUnits);
        try {
            new Chart(topRequestingCtx, {
                type: 'bar',
                data: {
                    labels: window.distributionReportData.topRequestingUnits.map(function(item) {
                        return (item.requester_agency_unit__acronym || item.requester_agency_unit__name || 'Unidade').substring(0, 20) + (item.requester_agency_unit__name && item.requester_agency_unit__name.length > 20 ? '...' : '');
                    }),
                    datasets: [{
                        label: 'Solicitações',
                        data: window.distributionReportData.topRequestingUnits.map(function(item) {
                            return item.request_count || 0;
                        }),
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Unidades Solicitantes'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
            console.log('Top requesting units chart created successfully');
        } catch (error) {
            console.error('Error creating top requesting units chart:', error);
        }
    } else {
        console.log('Top requesting units chart conditions not met:', {
            hasCanvas: !!topRequestingCtx,
            hasData: !!(window.distributionReportData && window.distributionReportData.topRequestingUnits),
            dataLength: window.distributionReportData?.topRequestingUnits?.length || 0
        });
    }
}
</script>
{% endblock %}
