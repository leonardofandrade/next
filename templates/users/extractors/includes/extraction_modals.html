<!-- Modal Atribuir-me -->
{% if extraction.status == 'pending' %}
<div class="modal fade" id="assignModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="assignModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="assignModalLabel{{ extraction.pk }}">
                    <i class="fas fa-user-check me-2"></i>
                    Atribuir Extração a Mim
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Você está prestes a se tornar responsável por esta extração.
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Extração:</strong> #{{ extraction.pk }}
                    </div>
                    <div class="col-12">
                        <strong>Dispositivo:</strong> 
                        {% if extraction.case_device.device_model %}
                            {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                        {% else %}
                            Sem modelo
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <strong>Processo:</strong> {{ extraction.case_device.case.number|default:"Rascunho" }}
                    </div>
                    <div class="col-6">
                        <strong>Status:</strong> 
                        <span class="badge bg-{{ extraction.get_status_color }}">{{ extraction.get_status_display }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form method="post" action="{% url 'extractions:assign_to_me' extraction.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-user-check me-2"></i>
                        Confirmar Atribuição
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Desatribuir-me -->
<div class="modal fade" id="unassignModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="unassignModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="unassignModalLabel{{ extraction.pk }}">
                    <i class="fas fa-user-times me-2"></i>
                    Desatribuir Extração de Mim
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Você está prestes a remover sua responsabilidade sobre esta extração.
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Extração:</strong> #{{ extraction.pk }}
                    </div>
                    <div class="col-12">
                        <strong>Dispositivo:</strong> 
                        {% if extraction.case_device.device_model %}
                            {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                        {% else %}
                            Sem modelo
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <strong>Processo:</strong> {{ extraction.case_device.case.number|default:"Rascunho" }}
                    </div>
                    <div class="col-6">
                        <strong>Status:</strong> 
                        <span class="badge bg-{{ extraction.get_status_color }}">{{ extraction.get_status_display }}</span>
                    </div>
                    {% if extraction.assigned_at %}
                    <div class="col-12">
                        <strong>Atribuído em:</strong> {{ extraction.assigned_at|date:"d/m/Y H:i" }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form method="post" action="{% url 'extractions:unassign_from_me' extraction.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-user-times me-2"></i>
                        Confirmar Desatribuição
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Iniciar Extração -->
<div class="modal fade" id="startModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="startModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="startModalLabel{{ extraction.pk }}">
                    <i class="fas fa-play me-2"></i>
                    Iniciar Extração
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Você está prestes a iniciar esta extração.
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Extração:</strong> #{{ extraction.pk }}
                    </div>
                    <div class="col-12">
                        <strong>Dispositivo:</strong> 
                        {% if extraction.case_device.device_model %}
                            {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                        {% else %}
                            Sem modelo
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <strong>Processo:</strong> {{ extraction.case_device.case.number|default:"Rascunho" }}
                    </div>
                    <div class="col-6">
                        <strong>Status Atual:</strong> 
                        <span class="badge bg-{{ extraction.get_status_color }}">{{ extraction.get_status_display }}</span>
                    </div>
                </div>
                <hr>
                <form id="startForm{{ extraction.pk }}" method="post" action="{% url 'extractions:start' extraction.pk %}" class="ajax-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="notes{{ extraction.pk }}" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>
                            Observações (Opcional)
                        </label>
                        <textarea class="form-control" id="notes{{ extraction.pk }}" name="notes" rows="3" 
                                  placeholder="Adicione observações sobre o início da extração..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="submit" form="startForm{{ extraction.pk }}" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>
                    Iniciar Extração
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Pausar Extração -->
<div class="modal fade" id="pauseModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="pauseModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="pauseModalLabel{{ extraction.pk }}">
                    <i class="fas fa-pause me-2"></i>
                    Pausar Extração
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Você está prestes a pausar esta extração.
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Extração:</strong> #{{ extraction.pk }}
                    </div>
                    <div class="col-12">
                        <strong>Dispositivo:</strong> 
                        {% if extraction.case_device.device_model %}
                            {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                        {% else %}
                            Sem modelo
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <strong>Processo:</strong> {{ extraction.case_device.case.number|default:"Rascunho" }}
                    </div>
                </div>
                <hr>
                <form id="pauseForm{{ extraction.pk }}" method="post" action="{% url 'extractions:pause' extraction.pk %}" class="ajax-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="pauseNotes{{ extraction.pk }}" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>
                            Observações (Opcional)
                        </label>
                        <textarea class="form-control" id="pauseNotes{{ extraction.pk }}" name="notes" rows="3" 
                                  placeholder="Adicione observações sobre a pausa da extração...">{% if extraction.paused_notes %}{{ extraction.paused_notes }}{% endif %}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="submit" form="pauseForm{{ extraction.pk }}" class="btn btn-warning">
                    <i class="fas fa-pause me-2"></i>
                    Pausar Extração
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Retomar Extração -->
<div class="modal fade" id="resumeModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="resumeModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="resumeModalLabel{{ extraction.pk }}">
                    <i class="fas fa-play me-2"></i>
                    Retomar Extração
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Você está prestes a retomar esta extração pausada.
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Extração:</strong> #{{ extraction.pk }}
                    </div>
                    <div class="col-12">
                        <strong>Dispositivo:</strong> 
                        {% if extraction.case_device.device_model %}
                            {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                        {% else %}
                            Sem modelo
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <strong>Processo:</strong> {{ extraction.case_device.case.number|default:"Rascunho" }}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form method="post" action="{% url 'extractions:resume' extraction.pk %}" style="display: inline;" class="ajax-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-play me-2"></i>
                        Retomar Extração
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Iniciar Força Bruta -->
{% if extraction.assigned_to and extraction.assigned_to.user == request.user %}
{% if not extraction.brute_force_started_at %}
<div class="modal fade" id="startBruteForceModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="startBruteForceModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="startBruteForceModalLabel{{ extraction.pk }}">
                    <i class="fas fa-unlock-alt me-2"></i>
                    Iniciar Força Bruta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Você está prestes a iniciar a força bruta para desbloquear este dispositivo.
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Extração:</strong> #{{ extraction.pk }}
                    </div>
                    <div class="col-12">
                        <strong>Dispositivo:</strong> 
                        {% if extraction.case_device.device_model %}
                            {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                        {% else %}
                            Sem modelo
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <strong>Processo:</strong> {{ extraction.case_device.case.number|default:"Rascunho" }}
                    </div>
                </div>
                <hr>
                <form id="startBruteForceForm{{ extraction.pk }}" method="post" action="{% url 'extractions:brute_force_start' extraction.pk %}" class="ajax-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="bruteForceNotes{{ extraction.pk }}" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>
                            Observações (Opcional)
                        </label>
                        <textarea class="form-control" id="bruteForceNotes{{ extraction.pk }}" name="notes" rows="3" 
                                  placeholder="Adicione observações sobre o início da força bruta..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="submit" form="startBruteForceForm{{ extraction.pk }}" class="btn btn-danger">
                    <i class="fas fa-unlock-alt me-2"></i>
                    Iniciar Força Bruta
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Finalizar Extração -->
{% if extraction.status == 'in_progress' or extraction.status == 'paused' %}
{% if extraction.assigned_to and extraction.assigned_to.user == request.user %}
<div class="modal fade" id="finishExtractionModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="finishExtractionModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="finishExtractionModalLabel{{ extraction.pk }}">
                    <i class="fas fa-check-circle me-2"></i>
                    Finalizar Extração
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="finishExtractionModalBody{{ extraction.pk }}">
                <div class="text-center py-4">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando formulário...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- Modal Finalizar Força Bruta -->
{% if extraction.brute_force_started_at and not extraction.brute_force_finished_at %}
<div class="modal fade" id="finishBruteForceModal{{ extraction.pk }}" tabindex="-1" aria-labelledby="finishBruteForceModalLabel{{ extraction.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="finishBruteForceModalLabel{{ extraction.pk }}">
                    <i class="fas fa-unlock me-2"></i>
                    Finalizar Força Bruta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="finishBruteForceModalBody{{ extraction.pk }}">
                <div class="text-center py-4">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando formulário...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

