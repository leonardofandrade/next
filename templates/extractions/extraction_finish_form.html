{% extends '_global/layout/base.html' %}
{% load static %}

{% block page_title %}
<i class="fas {{ page_icon }} text-success me-2"></i>
{{ page_title }}
{% endblock page_title %}

{% block page_description %}
Preencha os dados da finalização da extração
{% endblock page_description %}

{% block page_actions %}
<a href="{% url 'extractions:case_extractions' extraction.case_device.case.pk %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Voltar
</a>
{% endblock page_actions %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Informações da Extração -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações da Extração
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <strong>Extração:</strong><br>
                            <span class="badge bg-secondary fs-6">#{{ extraction.pk }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Status:</strong><br>
                            <span class="badge bg-{{ extraction.get_status_color }} fs-6">
                                {{ extraction.get_status_display }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Processo:</strong><br>
                            <span class="badge bg-secondary fs-6">{{ extraction.case_device.case.number|default:"Rascunho" }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Unidade:</strong><br>
                            {% if extraction.case_device.case.extraction_unit %}
                                <span class="badge bg-info fs-6">{{ extraction.case_device.case.extraction_unit.acronym }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Dispositivo:</strong><br>
                            {% if extraction.case_device.device_model %}
                                {{ extraction.case_device.device_model.brand.name }} - {{ extraction.case_device.device_model.name }}
                            {% else %}
                                <span class="text-muted">Sem modelo</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Atribuído a:</strong><br>
                            {% if extraction.assigned_to %}
                                <i class="fas fa-user me-1"></i>
                                {{ extraction.assigned_to.user.get_full_name|default:extraction.assigned_to.user.username }}
                            {% else %}
                                <span class="text-muted">Não atribuído</span>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <strong>Iniciado em:</strong><br>
                            {% if extraction.started_at %}
                                {{ extraction.started_at|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <strong>Iniciado por:</strong><br>
                            {% if extraction.started_by %}
                                {{ extraction.started_by.user.get_full_name|default:extraction.started_by.user.username }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                        {% if extraction.started_notes %}
                        <div class="col-md-12">
                            <strong>Observações do Início:</strong><br>
                            <div class="alert alert-secondary mb-0 mt-2">
                                {{ extraction.started_notes|linebreaksbr }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário de Finalização -->
        <div class="col-12">
            <form method="post" action="{% url 'extractions:finish' extraction.pk %}" id="finishForm">
                {% csrf_token %}
                
                <!-- Resultado da Extração -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            Resultado da Extração
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.extraction_result.id_for_label }}" class="form-label">
                                    {{ form.extraction_result.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.extraction_result }}
                                {% if form.extraction_result.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.extraction_result.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-12">
                                <label for="{{ form.extraction_results_notes.id_for_label }}" class="form-label">
                                    {{ form.extraction_results_notes.label }}
                                </label>
                                {{ form.extraction_results_notes }}
                                {% if form.extraction_results_notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.extraction_results_notes.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-12">
                                <label for="{{ form.finished_notes.id_for_label }}" class="form-label">
                                    {{ form.finished_notes.label }}
                                </label>
                                {{ form.finished_notes }}
                                {% if form.finished_notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.finished_notes.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tipos de Extração -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-layer-group me-2"></i>
                            Tipos de Extração Realizados
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Extração Lógica -->
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.logical_extraction }}
                                    <label class="form-check-label" for="{{ form.logical_extraction.id_for_label }}">
                                        {{ form.logical_extraction.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-12" id="logical_extraction_notes_div" style="display: none;">
                                <label for="{{ form.logical_extraction_notes.id_for_label }}" class="form-label">
                                    {{ form.logical_extraction_notes.label }}
                                </label>
                                {{ form.logical_extraction_notes }}
                            </div>

                            <!-- Extração Física -->
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.physical_extraction }}
                                    <label class="form-check-label" for="{{ form.physical_extraction.id_for_label }}">
                                        {{ form.physical_extraction.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-12" id="physical_extraction_notes_div" style="display: none;">
                                <label for="{{ form.physical_extraction_notes.id_for_label }}" class="form-label">
                                    {{ form.physical_extraction_notes.label }}
                                </label>
                                {{ form.physical_extraction_notes }}
                            </div>

                            <!-- Extração Completa do Sistema de Arquivos -->
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.full_file_system_extraction }}
                                    <label class="form-check-label" for="{{ form.full_file_system_extraction.id_for_label }}">
                                        {{ form.full_file_system_extraction.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-12" id="full_file_system_extraction_notes_div" style="display: none;">
                                <label for="{{ form.full_file_system_extraction_notes.id_for_label }}" class="form-label">
                                    {{ form.full_file_system_extraction_notes.label }}
                                </label>
                                {{ form.full_file_system_extraction_notes }}
                            </div>

                            <!-- Extração em Nuvem -->
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.cloud_extraction }}
                                    <label class="form-check-label" for="{{ form.cloud_extraction.id_for_label }}">
                                        {{ form.cloud_extraction.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-12" id="cloud_extraction_notes_div" style="display: none;">
                                <label for="{{ form.cloud_extraction_notes.id_for_label }}" class="form-label">
                                    {{ form.cloud_extraction_notes.label }}
                                </label>
                                {{ form.cloud_extraction_notes }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cellebrite Premium -->
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-star me-2"></i>
                            Cellebrite Premium
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Cellebrite Premium -->
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.cellebrite_premium }}
                                    <label class="form-check-label" for="{{ form.cellebrite_premium.id_for_label }}">
                                        {{ form.cellebrite_premium.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-12" id="cellebrite_premium_notes_div" style="display: none;">
                                <label for="{{ form.cellebrite_premium_notes.id_for_label }}" class="form-label">
                                    {{ form.cellebrite_premium_notes.label }}
                                </label>
                                {{ form.cellebrite_premium_notes }}
                            </div>

                            <!-- Suporte Cellebrite Premium -->
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.cellebrite_premium_support }}
                                    <label class="form-check-label" for="{{ form.cellebrite_premium_support.id_for_label }}">
                                        {{ form.cellebrite_premium_support.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-12" id="cellebrite_premium_support_notes_div" style="display: none;">
                                <label for="{{ form.cellebrite_premium_support_notes.id_for_label }}" class="form-label">
                                    {{ form.cellebrite_premium_support_notes.label }}
                                </label>
                                {{ form.cellebrite_premium_support_notes }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Armazenamento -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-hdd me-2"></i>
                            Armazenamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.extraction_size.id_for_label }}" class="form-label">
                                    {{ form.extraction_size.label }}
                                </label>
                                {{ form.extraction_size }}
                                {% if form.extraction_size.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.extraction_size.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.storage_media.id_for_label }}" class="form-label">
                                    {{ form.storage_media.label }}
                                </label>
                                {{ form.storage_media }}
                                {% if form.storage_media.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.storage_media.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'extractions:case_extractions' extraction.case_device.case.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Finalizar Extração
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Função para mostrar/ocultar campos de notas baseado nos checkboxes
        function toggleNotesField(checkboxId, divId) {
            const checkbox = document.getElementById(checkboxId);
            const notesDiv = document.getElementById(divId);
            
            if (checkbox && notesDiv) {
                // Mostra/oculta no carregamento da página
                notesDiv.style.display = checkbox.checked ? 'block' : 'none';
                
                // Adiciona listener para mudanças
                checkbox.addEventListener('change', function() {
                    notesDiv.style.display = this.checked ? 'block' : 'none';
                });
            }
        }
        
        // Aplica a função para todos os campos
        toggleNotesField('id_logical_extraction', 'logical_extraction_notes_div');
        toggleNotesField('id_physical_extraction', 'physical_extraction_notes_div');
        toggleNotesField('id_full_file_system_extraction', 'full_file_system_extraction_notes_div');
        toggleNotesField('id_cloud_extraction', 'cloud_extraction_notes_div');
        toggleNotesField('id_cellebrite_premium', 'cellebrite_premium_notes_div');
        toggleNotesField('id_cellebrite_premium_support', 'cellebrite_premium_support_notes_div');
    });
</script>
{% endblock %}
