{% extends '_global/layout/base.html' %}
{% load static %}
{% load form_tags %}

{% block page_title %}
<i class="fas {{ page_icon }} text-primary me-2"></i>
{{ page_title }}
{% endblock page_title %}

{% block page_description %}
Visualize os procedimentos e informações do processo
{% endblock page_description %}

{% block page_actions %}
<a href="{% if request.GET.next %}{{ request.GET.next }}{% else %}{% url 'cases:list' %}{% endif %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Voltar
</a>
{% endblock page_actions %}

{% block content %}
<div class="container-fluid py-4">
    {% include 'cases/includes/case_detail_include.html' with case=case %}

    <!-- Formulário de Procedimento -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" id="procedureFormTitle">
                        <i class="fas fa-plus me-2"></i>
                        Adicionar Procedimento
                    </h5>
                </div>
                <div class="card-body">
                    <form id="procedureForm" method="post" action="{% url 'cases:procedure_create' case_pk=case.pk %}?from=procedures" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        <input type="hidden" id="procedureId" name="procedure_id" value="">
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                {{ procedure_form.procedure_category|form_label_class }}
                                {{ procedure_form.procedure_category }}
                                {{ procedure_form.procedure_category.errors }}
                                {% if procedure_form.procedure_category.help_text %}
                                <small class="form-text text-muted">{{ procedure_form.procedure_category.help_text }}</small>
                                {% endif %}
                            </div>

                            <div class="col-md-2">
                                {{ procedure_form.number|form_label_class }}
                                {{ procedure_form.number }}
                                {{ procedure_form.number.errors }}
                                {% if procedure_form.number.help_text %}
                                <small class="form-text text-muted">{{ procedure_form.number.help_text }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                {{ procedure_form.document_file|form_label_class }}
                                {{ procedure_form.document_file }}
                                {{ procedure_form.document_file.errors }}
                                {% if procedure_form.document_file.help_text %}
                                <small class="form-text text-muted">{{ procedure_form.document_file.help_text }}</small>
                                {% endif %}
                                <div class="mt-2" id="currentFileInfo" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-file me-1"></i>
                                        Arquivo atual: <span id="currentFileName"></span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div id="editModeButtons" style="display: none;">
                                <button type="submit" class="btn btn-primary me-2" id="submitBtn">
                                    <i class="fas fa-save me-2"></i>
                                    <span id="submitBtnText">Salvar Alterações</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetProcedureForm()">
                                    <i class="fas fa-eraser me-2"></i>
                                    Limpar
                                </button>
                            </div>
                            <div id="createModeButtons">
                                <button type="submit" class="btn btn-primary" id="submitBtnCreate">
                                    <i class="fas fa-save me-2"></i>
                                    Salvar Procedimento
                                </button>
                            </div>
                            <button type="button" id="cancelEditBtn" class="btn btn-secondary" style="display: none;" onclick="resetProcedureForm()">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Procedimentos do Caso -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-gavel me-2"></i>
                        Procedimentos do Processo
                    </h5>
                </div>
                <div class="card-body">
                    {% if procedures %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="20%">Categoria</th>
                                    <th width="30%">Número</th>
                                    <th width="25%">Arquivo</th>
                                    <th width="15%">Criado em</th>
                                    <th width="10%" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for procedure in procedures %}
                                <tr>
                                    <td>                                        
                                        <strong>{{ procedure.procedure_category.name }}</strong>
                                    </td>
                                    <td>
                                        <strong>{{ procedure.number|default:"-" }}</strong>
                                    </td>
                                    <td>
                                        {% if procedure.original_filename %}
                                            <i class="fas fa-file me-1"></i>
                                            <small>{{ procedure.original_filename|truncatechars:30 }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ procedure.created_at|date:"d/m/Y H:i"|default:"-" }}</small>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" 
                                                    class="btn btn-outline-primary edit-procedure-btn" 
                                                    title="Editar"
                                                    data-procedure-id="{{ procedure.pk }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-danger delete-procedure-btn" 
                                                    title="Excluir"
                                                    data-procedure-id="{{ procedure.pk }}"
                                                    data-procedure-category="{% if procedure.procedure_category %}{{ procedure.procedure_category.name }}{% else %}-{% endif %}"
                                                    data-procedure-number="{{ procedure.number|default:'-' }}"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteProcedureModal">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% if procedure.document_file %}
                                            <a href="#" 
                                               class="btn btn-outline-secondary" 
                                               title="Download"
                                               onclick="alert('Funcionalidade de download em desenvolvimento'); return false;">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum procedimento cadastrado.</p>
                        <small class="text-muted">Os procedimentos são criados automaticamente ao criar o processo a partir de uma solicitação.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Exclusão de Procedimento -->
<div class="modal fade" id="deleteProcedureModal" tabindex="-1" aria-labelledby="deleteProcedureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteProcedureModalLabel">
                    <i class="fas fa-trash me-2"></i>
                    Excluir Procedimento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção!</strong> Esta ação não pode ser desfeita.
                </div>

                <p class="mb-3">Você tem certeza que deseja excluir o procedimento:</p>

                <div class="card mb-3">
                    <div class="card-body">
                        <dl class="row mb-0" id="deleteProcedureInfo">
                            <dt class="col-sm-4">Categoria:</dt>
                            <dd class="col-sm-8" id="deleteProcedureCategory">-</dd>

                            <dt class="col-sm-4">Número:</dt>
                            <dd class="col-sm-8" id="deleteProcedureNumber">-</dd>

                            <dt class="col-sm-4">Processo:</dt>
                            <dd class="col-sm-8">
                                <strong>{{ case.number|default:"Rascunho" }}</strong>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form id="deleteProcedureForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        Confirmar Exclusão
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa Select2 no formulário
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('#procedureForm select').select2({
            theme: 'bootstrap-5',
            language: {
                noResults: function() {
                    return "Nenhum resultado encontrado";
                },
                searching: function() {
                    return "Buscando...";
                }
            },
            width: '100%'
        });
    }
    
    // ===== EDIÇÃO DE PROCEDIMENTOS =====
    const procedureForm = document.getElementById('procedureForm');
    const procedureIdInput = document.getElementById('procedureId');
    const formTitle = document.getElementById('procedureFormTitle');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = document.getElementById('submitBtnText');
    const submitBtnCreate = document.getElementById('submitBtnCreate');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editModeButtons = document.getElementById('editModeButtons');
    const createModeButtons = document.getElementById('createModeButtons');
    const currentFileInfo = document.getElementById('currentFileInfo');
    const currentFileName = document.getElementById('currentFileName');
    const editButtons = document.querySelectorAll('.edit-procedure-btn');
    
    // Função para resetar o formulário para modo de criação
    window.resetProcedureForm = function() {
        procedureForm.reset();
        procedureIdInput.value = '';
        procedureForm.action = '{% url "cases:procedure_create" case_pk=case.pk %}?from=procedures';
        formTitle.innerHTML = '<i class="fas fa-plus me-2"></i>Adicionar Procedimento';
        cancelEditBtn.style.display = 'none';
        editModeButtons.style.display = 'none';
        createModeButtons.style.display = 'block';
        currentFileInfo.style.display = 'none';
        currentFileName.textContent = '';
        
        // Limpa o Select2
        if (typeof $ !== 'undefined' && $.fn.select2) {
            $('#procedureForm select').val(null).trigger('change');
        }
    };
    
    // Função para carregar dados do procedimento
    function loadProcedureData(procedureId) {
        fetch('{% url "cases:procedure_detail" case_pk=case.pk pk=0 %}'.replace('0', procedureId), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            // Preenche o formulário com os dados
            procedureIdInput.value = data.id;
            procedureForm.action = '{% url "cases:procedure_update" case_pk=case.pk pk=0 %}?from=procedures'.replace('0', data.id);
            
            // Preenche os campos
            if (data.procedure_category) {
                $('#procedureForm select[name="procedure_category"]').val(data.procedure_category).trigger('change');
            } else {
                $('#procedureForm select[name="procedure_category"]').val(null).trigger('change');
            }
            
            $('#procedureForm input[name="number"]').val(data.number);
            
            // Mostra informações do arquivo atual se existir
            if (data.original_filename) {
                currentFileName.textContent = data.original_filename;
                currentFileInfo.style.display = 'block';
            } else {
                currentFileInfo.style.display = 'none';
            }
            
            // Atualiza o título e botões
            formTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Procedimento';
            submitBtnText.textContent = 'Salvar Alterações';
            cancelEditBtn.style.display = 'inline-block';
            editModeButtons.style.display = 'block';
            createModeButtons.style.display = 'none';
            
            // Scroll suave até o formulário
            procedureForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            console.error('Erro ao carregar procedimento:', error);
            alert('Erro ao carregar dados do procedimento. Tente novamente.');
        });
    }
    
    // Adiciona listener para cada botão de editar
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const procedureId = this.getAttribute('data-procedure-id');
            loadProcedureData(procedureId);
        });
    });
    
    // Se houver erros de validação e estiver editando, carrega os dados
    {% if editing_procedure_id %}
    loadProcedureData({{ editing_procedure_id }});
    // Preenche os dados do formulário com os valores submetidos
    {% if form_data %}
    {% if form_data.procedure_category %}
    setTimeout(function() {
        $('#procedureForm select[name="procedure_category"]').val('{{ form_data.procedure_category }}').trigger('change');
    }, 500);
    {% endif %}
    $('#procedureForm input[name="number"]').val('{{ form_data.number|default:"" }}');
    {% endif %}
    {% endif %}
    
    // ===== EXCLUSÃO DE PROCEDIMENTOS =====
    const deleteProcedureModal = document.getElementById('deleteProcedureModal');
    const deleteProcedureForm = document.getElementById('deleteProcedureForm');
    const deleteButtons = document.querySelectorAll('.delete-procedure-btn');
    let currentDeleteProcedureId = null;
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            currentDeleteProcedureId = this.getAttribute('data-procedure-id');
            const category = this.getAttribute('data-procedure-category');
            const number = this.getAttribute('data-procedure-number');
            
            // Preenche as informações no modal
            document.getElementById('deleteProcedureCategory').textContent = category;
            document.getElementById('deleteProcedureNumber').textContent = number;
            
            // Atualiza a action do form
            deleteProcedureForm.action = '{% url "cases:procedure_delete" case_pk=case.pk pk=0 %}?from=procedures'.replace('0', currentDeleteProcedureId);
        });
    });
    
    // Submete o formulário de exclusão via AJAX
    deleteProcedureForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        
        // Desabilita o botão e mostra loading
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Excluindo...';
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            // Se status é 200 ou 302, considera sucesso (exclusão realizada)
            if (response.status === 200 || response.status === 302 || response.ok) {
                return { success: true };
            }
            
            // Se status é erro, tenta ler a resposta
            if (response.status >= 400) {
                return response.text().then(text => {
                    // Verifica se é JSON
                    try {
                        const jsonData = JSON.parse(text);
                        return jsonData;
                    } catch (e) {
                        // Se não é JSON, verifica se há erros no HTML
                        if (text.includes('alert-danger') || text.includes('Erro')) {
                            throw new Error('Erro ao excluir procedimento');
                        }
                        // Mesmo com erro HTTP, se não há mensagem de erro, considera sucesso
                        return { success: true };
                    }
                });
            }
            
            // Para outros status, tenta ler como JSON ou considera sucesso
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return response.json();
            }
            
            // Se não é JSON, assume sucesso (pode ser redirect)
            return { success: true };
        })
        .then(data => {
            // Se retornou JSON com success=false, mostra erro
            if (data && data.success === false) {
                throw new Error(data.error || 'Erro ao excluir procedimento');
            }
            
            // Qualquer outro caso, considera sucesso e recarrega
            const modal = bootstrap.Modal.getInstance(deleteProcedureModal);
            if (modal) {
                modal.hide();
            }
            window.location.reload();
        })
        .catch(error => {
            console.error('Erro ao excluir procedimento:', error);
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
            alert('Erro ao excluir procedimento: ' + (error.message || 'Tente novamente.'));
        });
    });
});
</script>
{% endblock %}