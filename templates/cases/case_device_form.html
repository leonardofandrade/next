{% extends '_global/layout/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">
                        <i class="fas {{ page_icon }} text-primary me-2"></i>
                        {{ page_title }}
                    </h1>
                    <p class="text-muted mb-0">
                        {% if action == 'create' %}
                            Adicione um novo dispositivo ao processo
                        {% else %}
                            Atualize os dados do dispositivo
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'cases:devices' case.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-12">
            <form method="post" novalidate>
                {% csrf_token %}
                
                <!-- Informações Básicas do Dispositivo -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-mobile-alt me-2"></i>
                            Informações do Dispositivo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.device_category.id_for_label }}" class="form-label">
                                    {{ form.device_category.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.device_category }}
                                {{ form.device_category.errors }}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.device_model.id_for_label }}" class="form-label">
                                    {{ form.device_model.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.device_model }}
                                {{ form.device_model.errors }}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.color.id_for_label }}" class="form-label">
                                    {{ form.color.label }}
                                </label>
                                {{ form.color }}
                                {% if form.color.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.color.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.owner_name.id_for_label }}" class="form-label">
                                    {{ form.owner_name.label }}
                                </label>
                                {{ form.owner_name }}
                                {% if form.owner_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.owner_name.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.internal_storage.id_for_label }}" class="form-label">
                                    {{ form.internal_storage.label }}
                                </label>
                                {{ form.internal_storage }}
                                {% if form.internal_storage.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.internal_storage.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IMEI -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-fingerprint me-2"></i>
                            IMEI
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    {{ form.is_imei_unknown }}
                                    <label class="form-check-label" for="{{ form.is_imei_unknown.id_for_label }}">
                                        {{ form.is_imei_unknown.label }}
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.imei_01.id_for_label }}" class="form-label">
                                    {{ form.imei_01.label }}
                                </label>
                                {{ form.imei_01 }}
                                {% if form.imei_01.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.imei_01.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label for="{{ form.imei_02.id_for_label }}" class="form-label">
                                    {{ form.imei_02.label }}
                                </label>
                                {{ form.imei_02 }}
                                {% if form.imei_02.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.imei_02.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.imei_03.id_for_label }}" class="form-label">
                                    {{ form.imei_03.label }}
                                </label>
                                {{ form.imei_03 }}
                                {% if form.imei_03.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.imei_03.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.imei_04.id_for_label }}" class="form-label">
                                    {{ form.imei_04.label }}
                                </label>
                                {{ form.imei_04 }}
                                {% if form.imei_04.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.imei_04.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.imei_05.id_for_label }}" class="form-label">
                                    {{ form.imei_05.label }}
                                </label>
                                {{ form.imei_05 }}
                                {% if form.imei_05.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.imei_05.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status do Dispositivo -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Status do Dispositivo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.is_turned_on }}
                                    <label class="form-check-label" for="{{ form.is_turned_on.id_for_label }}">
                                        {{ form.is_turned_on.label }}
                                    </label>
                                </div>
                                {% if form.is_turned_on.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_turned_on.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.is_locked }}
                                    <label class="form-check-label" for="{{ form.is_locked.id_for_label }}">
                                        {{ form.is_locked.label }}
                                    </label>
                                </div>
                                {% if form.is_locked.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_locked.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.is_sealed }}
                                    <label class="form-check-label" for="{{ form.is_sealed.id_for_label }}">
                                        {{ form.is_sealed.label }}
                                    </label>
                                </div>
                                {% if form.is_sealed.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_sealed.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-12" id="security_seal_field">
                                <label for="{{ form.security_seal.id_for_label }}" class="form-label">
                                    {{ form.security_seal.label }}
                                </label>
                                {{ form.security_seal }}
                                {% if form.security_seal.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.security_seal.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Senha -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-lock me-2"></i>
                            Informações de Senha
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    {{ form.is_password_known }}
                                    <label class="form-check-label" for="{{ form.is_password_known.id_for_label }}">
                                        {{ form.is_password_known.label }}
                                    </label>
                                </div>
                                {% if form.is_password_known.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_password_known.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.password_type.id_for_label }}" class="form-label">
                                    {{ form.password_type.label }}
                                </label>
                                {{ form.password_type }}
                                {% if form.password_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.password_type.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.password.id_for_label }}" class="form-label">
                                    {{ form.password.label }}
                                </label>
                                {{ form.password }}
                                {% if form.password.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.password.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Condição Física -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Condição Física
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    {{ form.is_damaged }}
                                    <label class="form-check-label" for="{{ form.is_damaged.id_for_label }}">
                                        {{ form.is_damaged.label }}
                                    </label>
                                </div>
                                {% if form.is_damaged.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_damaged.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    {{ form.has_fluids }}
                                    <label class="form-check-label" for="{{ form.has_fluids.id_for_label }}">
                                        {{ form.has_fluids.label }}
                                    </label>
                                </div>
                                {% if form.has_fluids.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.has_fluids.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-12" id="damage_description_field">
                                <label for="{{ form.damage_description.id_for_label }}" class="form-label">
                                    {{ form.damage_description.label }}
                                </label>
                                {{ form.damage_description }}
                                {% if form.damage_description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.damage_description.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-12" id="fluids_description_field">
                                <label for="{{ form.fluids_description.id_for_label }}" class="form-label">
                                    {{ form.fluids_description.label }}
                                </label>
                                {{ form.fluids_description }}
                                {% if form.fluids_description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.fluids_description.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acessórios -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-box me-2"></i>
                            Acessórios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    {{ form.has_sim_card }}
                                    <label class="form-check-label" for="{{ form.has_sim_card.id_for_label }}">
                                        {{ form.has_sim_card.label }}
                                    </label>
                                </div>
                                {% if form.has_sim_card.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.has_sim_card.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6" id="sim_card_info_field">
                                <label for="{{ form.sim_card_info.id_for_label }}" class="form-label">
                                    {{ form.sim_card_info.label }}
                                </label>
                                {{ form.sim_card_info }}
                                {% if form.sim_card_info.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.sim_card_info.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    {{ form.has_memory_card }}
                                    <label class="form-check-label" for="{{ form.has_memory_card.id_for_label }}">
                                        {{ form.has_memory_card.label }}
                                    </label>
                                </div>
                                {% if form.has_memory_card.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.has_memory_card.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6" id="memory_card_info_field">
                                <label for="{{ form.memory_card_info.id_for_label }}" class="form-label">
                                    {{ form.memory_card_info.label }}
                                </label>
                                {{ form.memory_card_info }}
                                {% if form.memory_card_info.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.memory_card_info.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    {{ form.has_other_accessories }}
                                    <label class="form-check-label" for="{{ form.has_other_accessories.id_for_label }}">
                                        {{ form.has_other_accessories.label }}
                                    </label>
                                </div>
                                {% if form.has_other_accessories.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.has_other_accessories.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6" id="other_accessories_info_field">
                                <label for="{{ form.other_accessories_info.id_for_label }}" class="form-label">
                                    {{ form.other_accessories_info.label }}
                                </label>
                                {{ form.other_accessories_info }}
                                {% if form.other_accessories_info.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.other_accessories_info.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações Adicionais -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sticky-note me-2"></i>
                            Informações Adicionais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="{{ form.additional_info.id_for_label }}" class="form-label">
                                    {{ form.additional_info.label }}
                                </label>
                                {{ form.additional_info }}
                                {% if form.additional_info.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.additional_info.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% if action == 'create' %}
                                        Adicionar Dispositivo
                                    {% else %}
                                        Salvar Alterações
                                    {% endif %}
                                </button>
                            </div>
                            <a href="{% url 'cases:devices' case.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializa Select2 para device_model com busca e tema Bootstrap 5
    $('#{{ form.device_model.id_for_label }}').select2({
        theme: 'bootstrap-5',
        language: {
            noResults: function() {
                return "Nenhum resultado encontrado";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        placeholder: 'Digite para pesquisar o modelo do dispositivo...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 0,
        closeOnSelect: true
    });
    
    // Também inicializa para device_category se necessário
    $('#{{ form.device_category.id_for_label }}').select2({
        theme: 'bootstrap-5',
        language: {
            noResults: function() {
                return "Nenhum resultado encontrado";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        placeholder: 'Selecione uma categoria...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 0,
        closeOnSelect: true
    });
    
    // Função para habilitar/desabilitar campos condicionais
    function toggleField(checkboxId, fieldId) {
        const checkbox = document.getElementById(checkboxId);
        const field = document.getElementById(fieldId);
        
        if (checkbox && field) {
            const input = field.querySelector('input, textarea');
            
            function updateFieldState() {
                const isChecked = checkbox.checked;
                
                if (input) {
                    input.disabled = !isChecked;
                    
                    // Adiciona classe visual para indicar estado desabilitado
                    if (isChecked) {
                        input.classList.remove('bg-light');
                        field.style.opacity = '1';
                    } else {
                        input.classList.add('bg-light');
                        field.style.opacity = '0.6';
                    }
                }
            }
            
            // Atualiza na inicialização
            updateFieldState();
            
            // Adiciona listener para mudanças
            checkbox.addEventListener('change', updateFieldState);
        }
    }
    
    // Configurar campos condicionais
    toggleField('{{ form.is_sealed.id_for_label }}', 'security_seal_field');
    toggleField('{{ form.is_damaged.id_for_label }}', 'damage_description_field');
    toggleField('{{ form.has_fluids.id_for_label }}', 'fluids_description_field');
    toggleField('{{ form.has_sim_card.id_for_label }}', 'sim_card_info_field');
    toggleField('{{ form.has_memory_card.id_for_label }}', 'memory_card_info_field');
    toggleField('{{ form.has_other_accessories.id_for_label }}', 'other_accessories_info_field');
});
</script>
{% endblock %}

