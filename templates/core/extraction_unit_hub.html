{% extends '_global/layout/base.html' %}

{% block title %}{{ page_title|default:"Central da Unidade" }} - {{ block.super }}{% endblock %}

{% block page_title %}
<i class="fas {{ page_icon|default:'fa-sliders-h' }} me-2"></i>{{ page_title|default:"Central da Unidade" }}
{% endblock page_title %}

{% block page_description %}
{{ page_description|default:"Editar e configurar unidades de extração em um só lugar" }}
{% endblock page_description %}

{% block page_actions %}
{% if next_url %}
<a href="{{ next_url }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>Voltar
</a>
{% endif %}
<a href="{% url 'core:extraction_unit_list' %}" class="btn btn-secondary">
    <i class="fas fa-list me-2"></i>Lista de Unidades
</a>
<a href="{% url 'core:extraction_agency_graph' %}" class="btn btn-outline-primary">
    <i class="fas fa-project-diagram me-2"></i>Grafo
</a>
{% endblock page_actions %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-primary bg-opacity-10 text-primary rounded-3 p-3">
                                <i class="fas fa-home fa-lg"></i>
                            </div>
                        </div>
                        <div>
                            <div class="text-muted small">Unidade</div>
                            <div class="fw-bold">{{ unit.acronym }}</div>
                            <div class="text-muted small">{{ unit.agency.acronym }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-info bg-opacity-10 text-info rounded-3 p-3">
                                <i class="fas fa-file-signature fa-lg"></i>
                            </div>
                        </div>
                        <div>
                            <div class="text-muted small">Templates</div>
                            <div class="fw-bold">{{ document_templates|length }}</div>
                            <div class="text-muted small">
                                Padrão: {{ default_template.name|default:"—" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-success bg-opacity-10 text-success rounded-3 p-3">
                                <i class="fas fa-hdd fa-lg"></i>
                            </div>
                        </div>
                        <div>
                            <div class="text-muted small">Armazenamento</div>
                            <div class="fw-bold">{{ storage_media|length }}</div>
                            <div class="text-muted small">Itens cadastrados</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-warning bg-opacity-10 text-warning rounded-3 p-3">
                                <i class="fas fa-hashtag fa-lg"></i>
                            </div>
                        </div>
                        <div>
                            <div class="text-muted small">Numeração</div>
                            <div class="fw-bold">
                                {% if latest_dispatch_sequence %}
                                    {{ latest_dispatch_sequence.year }} · {{ latest_dispatch_sequence.last_number }}
                                {% else %}
                                    —
                                {% endif %}
                            </div>
                            <div class="text-muted small">Último ofício</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body d-flex flex-wrap gap-2">
            <span class="me-2 fw-bold text-muted"><i class="fas fa-bolt me-2 text-warning"></i>Ações rápidas:</span>
            <a class="btn btn-outline-primary" href="{% url 'core:extraction_unit_edit' unit.pk %}?next={{ hub_url|urlencode }}">
                <i class="fas fa-edit me-2"></i>Editar Unidade
            </a>
            <a class="btn btn-outline-info" href="{% url 'core:document_template_create' %}?extraction_unit={{ unit.pk }}&next={{ hub_url|urlencode }}">
                <i class="fas fa-plus me-2"></i>Novo Template
            </a>
            <a class="btn btn-outline-success" href="{% url 'core:storage_media_create' %}?extraction_unit={{ unit.pk }}&next={{ hub_url|urlencode }}">
                <i class="fas fa-plus me-2"></i>Novo Armazenamento
            </a>
            <a class="btn btn-outline-secondary" href="{% url 'core:evidence_location_create' %}?extraction_unit={{ unit.pk }}&next={{ hub_url|urlencode }}">
                <i class="fas fa-plus me-2"></i>Novo Local de Evidência
            </a>
            <a class="btn btn-outline-dark" href="{% url 'core:extraction_agency_graph' %}?agency={{ unit.agency.pk }}">
                <i class="fas fa-project-diagram me-2"></i>Grafo
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                {% if next_url %}
                    <input type="hidden" name="next" value="{{ next_url }}">
                {% endif %}
                <div class="col-md-8">
                    <label class="form-label" for="unit">Unidade</label>
                    <select class="form-select" id="unit" name="unit">
                        {% for u in units %}
                            <option value="{{ u.pk }}" {% if u.pk == unit.pk %}selected{% endif %}>
                                {{ u.agency.acronym }} · {{ u.acronym }} - {{ u.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label" for="tab">Aba</label>
                    <select class="form-select" id="tab" name="tab">
                        <option value="unit" {% if tab == 'unit' %}selected{% endif %}>Dados</option>
                        <option value="templates" {% if tab == 'templates' %}selected{% endif %}>Templates</option>
                        <option value="storage" {% if tab == 'storage' %}selected{% endif %}>Armazenamento</option>
                        <option value="evidence" {% if tab == 'evidence' %}selected{% endif %}>Locais de Evidência</option>
                        <option value="dispatch" {% if tab == 'dispatch' %}selected{% endif %}>Numeração de Ofícios</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" type="submit">
                        <i class="fas fa-sync me-2"></i>Abrir
                    </button>
                </div>
            </form>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link {% if tab == 'unit' %}active{% endif %}" href="{% url 'core:extraction_unit_hub' %}?unit={{ unit.pk }}&tab=unit{% if next_url %}&next={{ next_url|urlencode }}{% endif %}">Dados</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tab == 'templates' %}active{% endif %}" href="{% url 'core:extraction_unit_hub' %}?unit={{ unit.pk }}&tab=templates{% if next_url %}&next={{ next_url|urlencode }}{% endif %}">Templates</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tab == 'storage' %}active{% endif %}" href="{% url 'core:extraction_unit_hub' %}?unit={{ unit.pk }}&tab=storage{% if next_url %}&next={{ next_url|urlencode }}{% endif %}">Armazenamento</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tab == 'evidence' %}active{% endif %}" href="{% url 'core:extraction_unit_hub' %}?unit={{ unit.pk }}&tab=evidence{% if next_url %}&next={{ next_url|urlencode }}{% endif %}">Locais de Evidência</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tab == 'dispatch' %}active{% endif %}" href="{% url 'core:extraction_unit_hub' %}?unit={{ unit.pk }}&tab=dispatch{% if next_url %}&next={{ next_url|urlencode }}{% endif %}">Numeração</a>
        </li>
    </ul>

    {% if tab == 'unit' %}
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="h5 mb-0">{{ unit.acronym }} - {{ unit.name }}</div>
                        <div class="text-muted small">{{ unit.agency.acronym }} - {{ unit.agency.name }}</div>
                    </div>
                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-info" href="{% url 'core:extraction_unit_detail' unit.pk %}?next={{ hub_url|urlencode }}">
                            <i class="fas fa-folder-open me-2"></i>Detalhes
                        </a>
                        <a class="btn btn-outline-primary" href="{% url 'core:extraction_unit_edit' unit.pk %}?next={{ hub_url|urlencode }}">
                            <i class="fas fa-external-link-alt me-2"></i>Abrir Edição
                        </a>
                    </div>
                </div>

                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_unit">
                    <input type="hidden" name="tab" value="unit">

                    <div class="row">
                        {% for field in unit_form %}
                            <div class="{% if field.name == 'reply_email_template' %}col-12{% else %}col-12 col-md-6{% endif %} mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="text-danger small">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-save me-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    {% elif tab == 'templates' %}
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-file-signature me-2"></i>Templates ({{ document_templates|length }})</h5>
                    <div class="d-flex gap-2">
                        <a class="btn btn-primary" href="{% url 'core:document_template_create' %}?extraction_unit={{ unit.pk }}&next={{ hub_url|urlencode }}">
                            <i class="fas fa-plus me-2"></i>Novo Template
                        </a>
                    </div>
                </div>

                {% if document_templates %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Padrão</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in document_templates %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold">{{ t.name }}</div>
                                            {% if t.description %}<div class="text-muted small">{{ t.description|truncatechars:120 }}</div>{% endif %}
                                        </td>
                                        <td>
                                            {% if t.is_default %}
                                                <span class="badge bg-success">Sim</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Não</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <a class="btn btn-sm btn-info" href="{% url 'core:document_template_detail' t.pk %}?next={{ hub_url|urlencode }}" title="Detalhes">
                                                <i class="fas fa-folder-open"></i>
                                            </a>
                                            <a class="btn btn-sm btn-warning" href="{% url 'core:document_template_update' t.pk %}?next={{ hub_url|urlencode }}" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a class="btn btn-sm btn-danger" href="{% url 'core:document_template_delete' t.pk %}?next={{ hub_url|urlencode }}" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-file-signature fa-3x mb-3 opacity-25"></i>
                        <div>Nenhum template cadastrado para esta unidade.</div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% elif tab == 'storage' %}
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-hdd me-2"></i>Meios de Armazenamento ({{ storage_media|length }})</h5>
                    <div class="d-flex gap-2">
                        <a class="btn btn-primary" href="{% url 'core:storage_media_create' %}?extraction_unit={{ unit.pk }}&next={{ hub_url|urlencode }}">
                            <i class="fas fa-plus me-2"></i>Novo
                        </a>
                    </div>
                </div>

                {% if storage_media %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Sigla</th>
                                    <th>Nome</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in storage_media %}
                                    <tr>
                                        <td class="fw-bold">{{ m.acronym }}</td>
                                        <td>{{ m.name }}</td>
                                        <td class="text-end">
                                            <a class="btn btn-sm btn-warning" href="{% url 'core:storage_media_edit' m.pk %}?next={{ hub_url|urlencode }}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a class="btn btn-sm btn-danger" href="{% url 'core:storage_media_delete' m.pk %}?next={{ hub_url|urlencode }}">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-hdd fa-3x mb-3 opacity-25"></i>
                        <div>Nenhum meio de armazenamento cadastrado para esta unidade.</div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% elif tab == 'evidence' %}
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-archive me-2"></i>Locais de Evidência ({{ evidence_locations|length }})</h5>
                    <div class="d-flex gap-2">
                        <a class="btn btn-primary" href="{% url 'core:evidence_location_create' %}?extraction_unit={{ unit.pk }}&next={{ hub_url|urlencode }}">
                            <i class="fas fa-plus me-2"></i>Novo
                        </a>
                    </div>
                </div>

                {% if evidence_locations %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nome</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loc in evidence_locations %}
                                    <tr>
                                        <td>{{ loc.get_type_display|default:loc.type }}</td>
                                        <td class="fw-bold">{{ loc.name }}</td>
                                        <td class="text-end">
                                            <a class="btn btn-sm btn-warning" href="{% url 'core:evidence_location_edit' loc.pk %}?next={{ hub_url|urlencode }}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a class="btn btn-sm btn-danger" href="{% url 'core:evidence_location_delete' loc.pk %}?next={{ hub_url|urlencode }}">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-archive fa-3x mb-3 opacity-25"></i>
                        <div>Nenhum local de evidência cadastrado para esta unidade.</div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% elif tab == 'dispatch' %}
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-hashtag me-2"></i>Numeração de Ofícios</h5>
                    <span class="text-muted small">Gerado automaticamente ao emitir ofícios</span>
                </div>

                {% if dispatch_sequences %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Ano</th>
                                    <th>Último Número</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in dispatch_sequences %}
                                    <tr>
                                        <td class="fw-bold">{{ s.year }}</td>
                                        <td>{{ s.last_number }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-hashtag fa-3x mb-3 opacity-25"></i>
                        <div>Nenhuma numeração registrada ainda para esta unidade.</div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

