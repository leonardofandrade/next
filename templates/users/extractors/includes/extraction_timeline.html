<div class="timeline-row">
    <div class="timeline-container rounded p-3 shadow-sm">
        <div class="row g-0 align-items-center">
            <!-- Coluna 1: Dados do Dispositivo -->
            <div class="col-auto">
                <div class="timeline-step">
                    <div class="timeline-marker d-flex align-items-center justify-content-center bg-primary text-white border border-primary rounded mb-2" 
                         style="width: auto; min-width: 100px; padding: 4px 8px; z-index: 2; box-shadow: 0 2px 6px rgba(0, 123, 255, 0.4);">
                        <small class="fw-bold">Dispositivo</small>
                    </div>
                    <div class="card border-primary bg-light timeline-card">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <h6 class="card-title mb-0">
                                    <strong class="text-primary">#{{ extraction.pk }}</strong>
                                </h6>
                                <div class="d-flex gap-1">
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary" 
                                            title="Editar Dispositivo"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editDeviceModal{{ extraction.case_device.pk }}"
                                            data-device-id="{{ extraction.case_device.pk }}"
                                            data-case-id="{{ extraction.case_device.case.pk }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="{% url 'cases:detail' extraction.case_device.case.pk %}" 
                                       class="btn btn-sm btn-outline-info" 
                                       title="Ver Processo">
                                        <i class="fas fa-folder-open"></i>
                                    </a>
                                    {% if not extraction.started_at %}
                                        <form method="post" action="{% url 'extractions:unassign_from_me' extraction.pk %}" class="d-inline ajax-form">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    title="Desatribuir-me"
                                                    onclick="return confirm('Tem certeza que deseja se desatribuir desta extração?');">
                                                <i class="fas fa-user-times"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-3 align-items-center small">
                                {% if extraction.case_device.device_model %}
                                    <span>
                                        <i class="fas fa-mobile-alt me-1"></i>
                                        <strong>{{ extraction.case_device.device_model.brand.name }}</strong> {{ extraction.case_device.device_model.name }}
                                    </span>
                                {% else %}
                                    <span>
                                        <i class="fas fa-mobile-alt me-1"></i>Sem modelo
                                    </span>
                                {% endif %}
                                {% if extraction.case_device.imei_01 %}
                                    <span class="text-muted">
                                        <i class="fas fa-fingerprint me-1"></i>IMEI: {{ extraction.case_device.imei_01 }}
                                    </span>
                                {% endif %}
                                <a href="{% url 'cases:detail' extraction.case_device.case.pk %}" class="text-decoration-none">
                                    <i class="fas fa-folder-open me-1"></i>{{ extraction.case_device.case.number|default:"Rascunho" }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna 2: Espaçamento com Seta -->
            <div class="col-auto d-flex align-items-center justify-content-center px-3">
                <i class="fas fa-chevron-right text-primary" style="font-size: 1.25rem; opacity: 0.6;"></i>
            </div>
            
            <!-- Coluna 3: Iniciar -->
            <div class="col-auto">
                <div class="timeline-step {% if extraction.status == 'assigned' %}active{% elif extraction.started_at %}completed{% else %}disabled{% endif %}">
                    <div class="timeline-marker d-flex align-items-center justify-content-center {% if extraction.started_at %}bg-success text-white border-success{% elif extraction.status == 'assigned' %}bg-primary text-white border-primary{% else %}bg-light border-secondary text-muted{% endif %} rounded mb-2" 
                         style="width: auto; min-width: 100px; padding: 4px 8px; margin: 0 auto; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <small class="fw-bold">Início</small>
                    </div>
                    <div class="card {% if extraction.started_at %}border-success{% elif extraction.status == 'assigned' %}border-primary{% else %}border-secondary{% endif %} {% if not extraction.started_at and extraction.status != 'assigned' %}timeline-disabled{% endif %} timeline-card">
                        <div class="card-body p-2 d-flex flex-column justify-content-center align-items-center">
                            {% if extraction.status == 'assigned' %}
                                <button type="button" 
                                        class="btn btn-primary btn-lg w-100 mb-2" 
                                        title="Iniciar Extração"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#startModal{{ extraction.pk }}">
                                    <i class="fas fa-play me-2"></i>
                                    Iniciar Extração
                                </button>
                            {% elif extraction.started_at %}
                                <div class="w-100">
                                    <p class="card-text small mb-0 text-muted text-center">
                                        <i class="fas fa-calendar-alt me-1"></i>{{ extraction.started_at|date:"d/m H:i" }}
                                        {% if extraction.started_notes %}
                                            <br>
                                            <span class="mt-1 d-block" title="{{ extraction.started_notes }}">
                                                <i class="fas fa-sticky-note me-1"></i>{{ extraction.started_notes|truncatewords:5 }}
                                            </span>
                                        {% endif %}
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna 4: Espaçamento com Seta -->
            <div class="col-auto d-flex align-items-center justify-content-center px-3">
                <i class="fas fa-chevron-right text-primary" style="font-size: 1.25rem; opacity: 0.6;"></i>
            </div>
            
            <!-- Coluna 5: Em Andamento -->
            <div class="col-auto">
                <div class="timeline-step {% if extraction.status == 'in_progress' or extraction.status == 'paused' %}active{% elif extraction.status == 'completed' %}completed{% else %}disabled{% endif %} {% if extraction.brute_force_started_at and not extraction.brute_force_finished_at %}brute-force-active{% endif %}">
                    <div class="timeline-marker d-flex align-items-center justify-content-center {% if extraction.brute_force_started_at and not extraction.brute_force_finished_at %}bg-danger text-white border-danger{% elif extraction.status == 'completed' %}bg-success text-white border-success{% elif extraction.status == 'paused' %}bg-secondary text-white border-secondary{% elif extraction.status == 'in_progress' %}bg-primary text-white border-primary{% else %}bg-light border-secondary text-muted{% endif %} rounded mb-2" 
                         style="width: auto; min-width: 100px; padding: 4px 8px; margin: 0 auto; z-index: 2; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <small class="fw-bold">
                            {% if extraction.status == 'paused' %}
                                Pausada
                            {% elif extraction.brute_force_started_at and not extraction.brute_force_finished_at %}
                                Em Força Bruta
                            {% else %}
                                Em Andamento
                            {% endif %}
                        </small>
                    </div>
                    <div class="card {% if extraction.brute_force_started_at and not extraction.brute_force_finished_at %}border-danger brute-force-card{% elif extraction.status == 'completed' %}border-success{% elif extraction.status == 'paused' %}border-secondary{% elif extraction.status == 'in_progress' %}border-primary{% else %}border-secondary{% endif %} {% if extraction.status != 'in_progress' and extraction.status != 'paused' and extraction.status != 'completed' %}timeline-disabled{% endif %} timeline-card">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center justify-content-end mb-1">
                                <div class="d-flex flex-wrap gap-1">
                                    {% if extraction.status == 'in_progress' %}
                                        {% if not extraction.brute_force_started_at %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    title="Iniciar Força Bruta"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#startBruteForceModal{{ extraction.pk }}">
                                                <i class="fas fa-unlock-alt"></i>
                                            </button>
                                        {% elif extraction.brute_force_started_at and not extraction.brute_force_finished_at %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    title="Finalizar Força Bruta"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#finishBruteForceModal{{ extraction.pk }}"
                                                    data-extraction-id="{{ extraction.pk }}">
                                                <i class="fas fa-unlock"></i>
                                            </button>
                                        {% endif %}
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-warning" 
                                                title="Pausar Extração"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#pauseModal{{ extraction.pk }}">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-secondary" 
                                                title="Cancelar Extração (volta para não iniciada)"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#cancelExtractionModal{{ extraction.pk }}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-success" 
                                                title="Finalizar Extração"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#finishExtractionModal{{ extraction.pk }}"
                                                data-extraction-id="{{ extraction.pk }}">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    {% elif extraction.status == 'paused' %}
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-success" 
                                                title="Retomar Extração"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#resumeModal{{ extraction.pk }}">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-success" 
                                                title="Finalizar Extração"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#finishExtractionModal{{ extraction.pk }}"
                                                data-extraction-id="{{ extraction.pk }}">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 align-items-center small">
                                {% if extraction.status == 'paused' and extraction.paused_notes %}
                                    <span class="text-muted" title="{{ extraction.paused_notes }}">
                                        <i class="fas fa-sticky-note me-1"></i>{{ extraction.paused_notes|truncatewords:3 }}
                                    </span>
                                {% endif %}
                                {% if extraction.brute_force_started_at or extraction.brute_force_finished_at %}
                                    <span class="text-muted">
                                        <i class="fas fa-unlock-alt me-1"></i>
                                        {% if extraction.brute_force_finished_at %}
                                            {% if extraction.brute_force_result %}
                                                <span class="badge bg-success">BF✓</span>
                                            {% else %}
                                                <span class="badge bg-secondary">BF</span>
                                            {% endif %}
                                        {% elif extraction.brute_force_started_at %}
                                            <span class="badge bg-danger">BF</span>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna 6: Espaçamento com Seta -->
            <div class="col-auto d-flex align-items-center justify-content-center px-3">
                <i class="fas fa-chevron-right text-primary" style="font-size: 1.25rem; opacity: 0.6;"></i>
            </div>
            
            <!-- Coluna 7: Finalizada -->
            <div class="col-auto">
                <div class="timeline-step {% if extraction.status == 'completed' %}completed{% else %}disabled{% endif %}">
                    <div class="timeline-marker d-flex align-items-center justify-content-center {% if extraction.status == 'completed' %}bg-success text-white border-success{% else %}bg-light border-secondary text-muted{% endif %} rounded mb-2" 
                         style="width: auto; min-width: 100px; padding: 4px 8px; margin: 0 auto; z-index: 2; box-shadow: 0 2px 6px rgba(40, 167, 69, 0.4);">
                        <small class="fw-bold">Finalização</small>
                    </div>
                    <div class="card {% if extraction.status == 'completed' %}border-success{% else %}border-secondary timeline-disabled{% endif %} timeline-card">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center justify-content-end mb-1">
                                {% if extraction.status == 'completed' and extraction.extraction_result %}
                                    {% if extraction.extraction_result == 'success' %}
                                        <span class="badge bg-success">✓ Sucesso</span>
                                    {% elif extraction.extraction_result == 'failed' %}
                                        <span class="badge bg-danger">✗ Falhou</span>
                                    {% elif extraction.extraction_result == 'partial' %}
                                        <span class="badge bg-warning">~ Parcial</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            {% if extraction.status == 'completed' %}
                                <div class="d-flex flex-wrap gap-2 align-items-center small">
                                    {% if extraction.finished_at %}
                                        <span class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>{{ extraction.finished_at|date:"d/m H:i" }}
                                        </span>
                                    {% endif %}
                                    {% if extraction.finished_notes %}
                                        <span class="text-muted" title="{{ extraction.finished_notes }}">
                                            <i class="fas fa-sticky-note me-1"></i>{{ extraction.finished_notes|truncatewords:3 }}
                                        </span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Layout específico da timeline - apenas o necessário */
.timeline-row {
    width: 100%;
}

.timeline-container {
    background: linear-gradient(to right, #f8f9fa 0%, #ffffff 100%);
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.timeline-container:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
    border-color: #dee2e6;
}

.timeline-step {
    position: relative;
}

/* Animação removida - títulos não oscilam mais */

/* Cards desabilitados */
.timeline-disabled {
    opacity: 0.5;
    pointer-events: none;
    background-color: #f8f9fa;
}

.timeline-disabled .card-title,
.timeline-disabled .card-text {
    color: #6c757d !important;
}

.timeline-disabled .btn {
    display: none;
}

/* Destaque para força bruta ativa - sem animação */
.brute-force-card {
    border-width: 2px !important;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
}

/* Cards com dimensões fixas */
.timeline-card {
    width: 280px;
    min-height: 120px;
    height: auto;
}

.timeline-card .card-body {
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* Responsividade */
@media (max-width: 1200px) {
    .timeline-card {
        width: 240px;
        min-height: 110px;
    }
    
    .timeline-card .card-body {
        min-height: 110px;
    }
}

@media (max-width: 768px) {
    .timeline-card {
        width: 200px;
        min-height: 100px;
    }
    
    .timeline-card .card-body {
        min-height: 100px;
    }
    
    .timeline-step .timeline-marker {
        width: 24px !important;
        height: 24px !important;
    }
}
</style>
