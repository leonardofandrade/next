{% extends '_global/layout/base.html' %}

{% block page_title %}Agência de Central de Extração{% endblock %}

{% block page_description %}
Configuração da Agência de Central de Extração.
{% endblock %}

{% block content %}
<style>
  .hierarchy-wrap { max-width: 1800px; margin: 0 auto; }
  :root {
    --hc-border: rgba(var(--bs-body-color-rgb), .12);
    --hc-border-soft: rgba(var(--bs-body-color-rgb), .08);
    --hc-surface: rgba(255, 255, 255, .86);
    --hc-surface-2: rgba(255, 255, 255, .72);
    --hc-primary-soft: rgba(var(--bs-primary-rgb), .12);
    --hc-primary: rgba(var(--bs-primary-rgb), .55);
  }
  .hierarchy-canvas {
    border-radius: 1rem;
    border: 1px solid var(--hc-border-soft);
    background:
      radial-gradient(circle at 1px 1px, rgba(var(--bs-body-color-rgb), .045) 1px, transparent 1px) 0 0 / 18px 18px,
      linear-gradient(180deg, rgba(var(--bs-primary-rgb), .055), rgba(255, 255, 255, 0));
  }
  .hierarchy-node { width: min(560px, 100%); }
  .hierarchy-top-card {
    border-radius: 1rem;
    border: 1px solid var(--hc-border-soft);
    background: var(--hc-surface);
    backdrop-filter: blur(8px);
  }
  .hierarchy-logo {
    width: 96px;
    height: 96px;
    border-radius: 999px;
    overflow: hidden;
    background: var(--bs-body-bg);
    border: 1px solid var(--hc-border-soft);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
      0 10px 24px rgba(0, 0, 0, .08),
      0 0 0 8px var(--hc-primary-soft);
  }
  .hierarchy-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 10px;
  }
  .hierarchy-connector {
    width: 2px;
    height: 26px;
    background: linear-gradient(
      180deg,
      var(--hc-primary),
      var(--hc-border)
    );
  }
  .org-hub {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: var(--hc-primary);
    box-shadow: 0 0 0 6px var(--hc-primary-soft);
  }
  .hierarchy-children-placeholder {
    border: 1px dashed var(--bs-border-color);
    background: var(--hc-surface-2);
    border-radius: 0.75rem;
  }

  /* Org chart (agency -> extraction units) */
  .org-children {
    position: relative;
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: .75rem;
    align-items: start;
    padding: 18px 0 6px 0; /* top space for the horizontal connector */
  }
  .org-children::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(
      90deg,
      transparent,
      var(--hc-border) 12%,
      var(--hc-border) 88%,
      transparent
    );
  }
  .org-child {
    position: relative;
    justify-self: center;
    width: min(220px, 100%);
    padding-top: 18px; /* space for vertical connector */
  }
  .org-child::before {
    content: "";
    position: absolute;
    top: 0;
    left: 50%;
    width: 2px;
    height: 18px;
    background: var(--hc-border);
    transform: translateX(-50%);
  }
  .org-child::after {
    content: "";
    position: absolute;
    top: -5px;
    left: 50%;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: var(--hc-border);
    transform: translateX(-50%);
  }
  .org-unit-card {
    border-radius: 0.9rem;
    border: 1px solid var(--hc-border-soft);
    border-top: 3px solid rgba(var(--bs-primary-rgb), .20);
    background: var(--hc-surface);
    backdrop-filter: blur(8px);
    transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  }
  .org-unit-card:hover {
    transform: translateY(-2px);
    border-color: rgba(var(--bs-primary-rgb), .25);
    box-shadow: 0 12px 26px rgba(0, 0, 0, .10);
  }
  .org-unit-acronym {
    font-weight: 700;
    letter-spacing: .3px;
    text-transform: uppercase;
    display: inline-block;
    padding: .35rem .7rem;
    border-radius: 999px;
    background: var(--hc-primary-soft);
    border: 1px solid rgba(var(--bs-primary-rgb), .18);
  }

  @media (prefers-reduced-motion: reduce) {
    .org-unit-card { transition: none; }
    .org-unit-card:hover { transform: none; }
  }
</style>

{% if agency %}
<div class="hierarchy-wrap">
  <div class="hierarchy-canvas p-3 p-lg-4">
  <div class="d-flex flex-column align-items-center">
    <!-- Top node: ExtractionAgency -->
    <div class="card shadow-sm hierarchy-node hierarchy-top-card">
      <div class="card-body">
        <div class="d-flex flex-column align-items-center text-center">
          <div class="hierarchy-logo mb-3">
            {% if agency.has_main_logo %}
              <img
                src="data:{{ agency.get_main_logo_mime_type }};base64,{{ agency.get_main_logo_base64 }}"
                alt="Logo {{ agency.acronym|default:'Agência' }}"
              >
            {% else %}
              <div class="text-muted fw-semibold">
                {{ agency.acronym|default:"AG"|slice:":3"|upper }}
              </div>
            {% endif %}
          </div>

          <div class="fw-semibold fs-5 lh-sm">
            {{ agency.name|default:"(sem nome)" }}
          </div>

          <div class="text-muted small mt-1">
            {% if agency.acronym %}{{ agency.acronym }}{% else %}&nbsp;{% endif %}
          </div>

          {% if agency.incharge_name or agency.incharge_position %}
            <div class="small mt-3">
              <span class="text-muted">Responsável:</span>
              {{ agency.incharge_name|default:"-" }}
              {% if agency.incharge_position %}
                <span class="text-muted">—</span> {{ agency.incharge_position }}
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Connector -->
    <div class="hierarchy-connector my-3"></div>
    <div class="org-hub mb-3"></div>

    <!-- Children area (future ExtractionUnits) -->
    <div class="w-100">
      <div class="text-muted small text-center mb-2">
        Unidades de Extração vinculadas{% if extraction_units %} ({{ extraction_units|length }}){% endif %}
      </div>

      {% if extraction_units %}
        <div class="org-children">
          {% for unit in extraction_units %}
            <div class="org-child">
              <div class="card shadow-sm org-unit-card">
                <div class="card-body py-3">
                  <div class="text-center">
                    <div class="org-unit-acronym fs-5">
                      {{ unit.acronym|default:"-" }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="hierarchy-children-placeholder p-4 text-center">
          <div class="fw-semibold">Nenhuma unidade cadastrada</div>
          <div class="text-muted small mt-1">
            Em breve esta área exibirá as <code>extraction_units</code> pertencentes à Agência.
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  </div>
</div>
{% else %}
<div class="alert alert-warning mb-0">
  Nenhuma agência de extração cadastrada.
</div>
{% endif %}
{% endblock %}
