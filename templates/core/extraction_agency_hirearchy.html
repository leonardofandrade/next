{% extends '_global/layout/base.html' %}

{% block page_title %}Hierarquia da Agência de Extração{% endblock %}

{% block page_description %}
Topo da hierarquia (Agência) e, futuramente, as Unidades de Extração vinculadas.
{% endblock %}

{% block content %}
<style>
  .hierarchy-wrap { max-width: 1100px; margin: 0 auto; }
  .hierarchy-node { width: min(560px, 100%); }
  .hierarchy-logo {
    width: 96px;
    height: 96px;
    border-radius: 999px;
    overflow: hidden;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .hierarchy-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 10px;
  }
  .hierarchy-connector {
    width: 2px;
    height: 26px;
    background: var(--bs-border-color);
  }
  .hierarchy-children-placeholder {
    border: 1px dashed var(--bs-border-color);
    background: rgba(255, 255, 255, 0.65);
    border-radius: 0.75rem;
  }

  /* Org chart (agency -> extraction units) */
  .org-children {
    position: relative;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    overflow-x: hidden;
    padding: 18px 0 6px 0; /* top space for the horizontal connector */
  }
  .org-children::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--bs-border-color);
  }
  .org-child {
    position: relative;
    flex: 1 1 200px;
    min-width: 160px;
    max-width: 260px;
    padding-top: 18px; /* space for vertical connector */
  }
  .org-child::before {
    content: "";
    position: absolute;
    top: 0;
    left: 50%;
    width: 2px;
    height: 18px;
    background: var(--bs-border-color);
    transform: translateX(-50%);
  }
  .org-unit-card {
    border-radius: 0.75rem;
  }
  .org-unit-acronym {
    font-weight: 700;
    letter-spacing: .3px;
  }
</style>

{% if agency %}
<div class="hierarchy-wrap">
  <div class="d-flex flex-column align-items-center">
    <!-- Top node: ExtractionAgency -->
    <div class="card shadow-sm hierarchy-node">
      <div class="card-body">
        <div class="d-flex flex-column align-items-center text-center">
          <div class="hierarchy-logo mb-3">
            {% if agency.has_main_logo %}
              <img
                src="data:{{ agency.get_main_logo_mime_type }};base64,{{ agency.get_main_logo_base64 }}"
                alt="Logo {{ agency.acronym|default:'Agência' }}"
              >
            {% else %}
              <div class="text-muted fw-semibold">
                {{ agency.acronym|default:"AG"|slice:":3"|upper }}
              </div>
            {% endif %}
          </div>

          <div class="fw-semibold fs-5 lh-sm">
            {{ agency.name|default:"(sem nome)" }}
          </div>

          <div class="text-muted small mt-1">
            {% if agency.acronym %}{{ agency.acronym }}{% else %}&nbsp;{% endif %}
          </div>

          {% if agency.incharge_name or agency.incharge_position %}
            <div class="small mt-3">
              <span class="text-muted">Responsável:</span>
              {{ agency.incharge_name|default:"-" }}
              {% if agency.incharge_position %}
                <span class="text-muted">—</span> {{ agency.incharge_position }}
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Connector -->
    <div class="hierarchy-connector my-3"></div>

    <!-- Children area (future ExtractionUnits) -->
    <div class="w-100">
      <div class="text-muted small text-center mb-2">
        Unidades de Extração vinculadas
      </div>

      {% if extraction_units %}
        <div class="org-children">
          {% for unit in extraction_units %}
            <div class="org-child">
              <div class="card shadow-sm org-unit-card">
                <div class="card-body py-3">
                  <div class="text-center">
                    <div class="org-unit-acronym fs-5">
                      {{ unit.acronym|default:"-" }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="hierarchy-children-placeholder p-4 text-center">
          <div class="fw-semibold">Nenhuma unidade cadastrada</div>
          <div class="text-muted small mt-1">
            Em breve esta área exibirá as <code>extraction_units</code> pertencentes à Agência.
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-warning mb-0">
  Nenhuma agência de extração cadastrada.
</div>
{% endif %}
{% endblock %}
