{% extends '_global/layout/base.html' %}
{% load static %}
{% load form_tags %}

{% block page_title %}
<i class="fas {{ page_icon }} text-primary me-2"></i>
{{ page_title }}
{% endblock page_title %}

{% block page_description %}
{% if action == 'create' %}
    Adicione um novo dispositivo ao processo
{% else %}
    Atualize os dados do dispositivo
{% endif %}
{% endblock page_description %}

{% block page_actions %}
<a href="{% url 'cases:devices' case.pk %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>
    Voltar
</a>
{% endblock page_actions %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Form -->
    <div class="row">
        <div class="col-12">
            <form method="post" novalidate>
                {% csrf_token %}
                
                <!-- Informações Básicas do Dispositivo -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-mobile-alt me-2"></i>
                            Identificação do Dispositivo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                {{ form.device_category|form_label_class }}
                                {{ form.device_category }}
                                {{ form.device_category.errors }}
                            </div>

                            <div class="col-md-7">
                                {{ form.device_model|form_label_class }}
                                {{ form.device_model }}
                                {{ form.device_model.errors }}
                            </div>

                            <div class="col-md-2">
                                {{ form.color|form_label_class }}
                                {{ form.color }}
                                {{ form.color.errors }}
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <div class="form-check form-switch form-label">
                                    {{ form.is_imei_unknown }}
                                    <label class="form-check-label" for="{{ form.is_imei_unknown.id_for_label }}">
                                        {{ form.is_imei_unknown.label }}
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                {{ form.imei_01 }}
                                {{ form.imei_01.errors }}
                            </div>

                            <div class="col-md-3">
                                {{ form.imei_02 }}
                                {{ form.imei_02.errors }}
                            </div>

                            <div class="col-md-3">
                                {{ form.imei_03 }}
                                {{ form.imei_03.errors }}
                            </div>

                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                {{ form.owner_name|form_label_class }}
                                {{ form.owner_name }}
                                {{ form.owner_name.errors }}
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch form-label">
                                    {{ form.is_sealed }}
                                    <label class="form-check-label" for="{{ form.is_sealed.id_for_label }}">
                                        {{ form.is_sealed.label }}
                                    </label>
                                </div>
                                <div id="security_seal_field">{{ form.security_seal }}</div>
                            </div>
                            <div class="col-md-3">
                                {{ form.internal_storage|form_label_class }}
                                {{ form.internal_storage }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status do Dispositivo -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Status e Segurança
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="form-check form-switch form-label">
                                    {{ form.is_turned_on }}
                                    <label class="form-check-label" for="{{ form.is_turned_on.id_for_label }}">
                                        {{ form.is_turned_on.label }}
                                    </label>
                                </div>
                    
                            </div>

                            <div class="col-md-3 ">
                                <div class="form-check form-switch form-label">
                                    {{ form.is_locked }}
                                    <label class="form-check-label" for="{{ form.is_locked.id_for_label }}">
                                        {{ form.is_locked.label }}
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                {{ form.password_type|form_label_class }}
                                {{ form.password_type }}
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch form-label">
                                    {{ form.is_password_known }}
                                    <label class="form-check-label" for="{{ form.is_password_known.id_for_label }}">
                                        {{ form.is_password_known.label }}
                                    </label>
                                </div>
                                <div id="password_field">{{ form.password }}</div>

                            </div>

                        </div>

                        </div>
                    </div>
                </div>
                <!-- Condição Física -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Condição Física
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch form-label">
                                    {{ form.is_damaged }}
                                    <label class="form-check-label" for="{{ form.is_damaged.id_for_label }}">
                                        {{ form.is_damaged.label }}
                                    </label>
                                </div>
                                <div id="damage_description_field">{{ form.damage_description }}</div>

                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch form-label">
                                    <div id="has_fluids_field"> {{ form.has_fluids }}</div>
                                    <label class="form-check-label" for="{{ form.has_fluids.id_for_label }}">
                                        {{ form.has_fluids.label }}
                                    </label>
                                </div>
                                <div id="fluids_description_field">{{ form.fluids_description }}</div>
                            </div>

                  
                        </div>
                    </div>
                </div>

                <!-- Acessórios -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sim-card me-2"></i>
                            Acessórios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check form-switch form-label">
                                    {{ form.has_sim_card }}
                                    <label class="form-check-label" for="{{ form.has_sim_card.id_for_label }}">
                                        {{ form.has_sim_card.label }}
                                    </label>
                                </div>
                                <div id="sim_card_info_field">{{ form.sim_card_info }}</div>
                            </div>


                            <div class="col-md-4">
                                <div class="form-check form-switch form-label">
                                    {{ form.has_memory_card }}
                                    <label class="form-check-label" for="{{ form.has_memory_card.id_for_label }}">
                                        {{ form.has_memory_card.label }}
                                    </label>
                                </div>
                                <div id="memory_card_info_field">{{ form.memory_card_info }}</div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-check form-switch form-label">
                                    {{ form.has_other_accessories }}
                                    <label class="form-check-label" for="{{ form.has_other_accessories.id_for_label }}">
                                        {{ form.has_other_accessories.label }}
                                    </label>
                                </div>
                                <div id="other_accessories_info_field">{{ form.other_accessories_info }}</div>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- Informações Adicionais -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-sticky-note me-2"></i>
                            Informações Adicionais
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="{{ form.additional_info.id_for_label }}" class="form-label">
                                    {{ form.additional_info.label }}
                                </label>
                                {{ form.additional_info }}
                                {% if form.additional_info.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.additional_info.errors }}
                                    </div>
                                {% endif %}
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% if action == 'create' %}
                                        Adicionar Dispositivo
                                    {% else %}
                                        Salvar Alterações
                                    {% endif %}
                                </button>
                            </div>
                            <a href="{% url 'cases:devices' case.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializa Select2 para device_model com busca e tema Bootstrap 5
    $('#{{ form.device_model.id_for_label }}').select2({
        theme: 'bootstrap-5',
        language: {
            noResults: function() {
                return "Nenhum resultado encontrado";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        placeholder: 'Digite para pesquisar o modelo do dispositivo...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 0,
        closeOnSelect: true
    });
    
    // Também inicializa para device_category se necessário
    /*
    $('#{{ form.device_category.id_for_label }}').select2({
        theme: 'bootstrap-5',
        language: {
            noResults: function() {
                return "Nenhum resultado encontrado";
            },
            searching: function() {
                return "Buscando...";
            }
        },
        placeholder: 'Selecione uma categoria...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 0,
        closeOnSelect: true
    });
    */
    // Função para habilitar/desabilitar campos condicionais
    function toggleField(checkboxId, fieldId) {
        const checkbox = document.getElementById(checkboxId);
        const field = document.getElementById(fieldId);
        
        if (checkbox && field) {
            const input = field.querySelector('input, textarea');
            
            function updateFieldState() {
                const isChecked = checkbox.checked;
                
                if (input) {
                    input.disabled = !isChecked;
                    
                    // Adiciona classe visual para indicar estado desabilitado
                    if (isChecked) {
                        input.classList.remove('bg-light');
                        field.style.opacity = '1';
                    } else {
                        input.classList.add('bg-light');
                        field.style.opacity = '0.6';
                    }
                }
            }
            
            // Atualiza na inicialização
            updateFieldState();
            
            // Adiciona listener para mudanças
            checkbox.addEventListener('change', updateFieldState);
        }
    }
    
    // Configurar campos condicionais
    toggleField('{{ form.is_sealed.id_for_label }}', 'security_seal_field');
    toggleField('{{ form.is_damaged.id_for_label }}', 'damage_description_field');
    toggleField('{{ form.has_fluids.id_for_label }}', 'fluids_description_field');
    toggleField('{{ form.has_sim_card.id_for_label }}', 'sim_card_info_field');
    toggleField('{{ form.has_memory_card.id_for_label }}', 'memory_card_info_field');
    toggleField('{{ form.has_other_accessories.id_for_label }}', 'other_accessories_info_field');
});
</script>
{% endblock %}

