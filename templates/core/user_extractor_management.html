{% extends '_global/layout/base.html' %}

{% block title %}Gerenciamento de Usuários e Extratores - {{ block.super }}{% endblock %}

{% block page_title %}
<i class="fas fa-users-cog me-2"></i>Gerenciamento de Usuários e Extratores
{% endblock page_title %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Lista de Usuários
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Usuário</th>
                                    <th>Email</th>
                                    <th>Unidade Operacional</th>
                                    <th>É Extrator?</th>
                                    <th>Agência</th>
                                    <th>Unidades Associadas</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-id="{{ user.pk }}">
                                    <td>
                                        <i class="fas fa-user-circle me-2"></i>
                                        <strong>{{ user.get_full_name|default:user.username }}</strong>
                                    </td>
                                    <td>{{ user.email|default:"-" }}</td>
                                    <td>
                                        {% if user.profile.agency_unit %}
                                            {{ user.profile.agency_unit.acronym }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="extractor-status" data-user-id="{{ user.pk }}">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="extractor-agency" data-user-id="{{ user.pk }}">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="extractor-units" data-user-id="{{ user.pk }}">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <button type="button" 
                                                    class="btn btn-sm btn-primary manage-extractor-btn" 
                                                    data-user-id="{{ user.pk }}"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#extractorModal">
                                                <i class="fas fa-cog"></i> Gerenciar
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-users fa-3x mb-3"></i>
                                        <p>Nenhum usuário encontrado.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para gerenciar extrator -->
<div class="modal fade" id="extractorModal" tabindex="-1" aria-labelledby="extractorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="extractorModalLabel">
                    <i class="fas fa-user-shield me-2"></i>Gerenciar Extrator
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="extractorModalBody">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const users = document.querySelectorAll('[data-user-id]');
    const userIds = Array.from(users).map(u => u.getAttribute('data-user-id'));
    
    // Carrega informações de todos os usuários
    userIds.forEach(userId => {
        loadUserExtractorInfo(userId);
    });
    
    // Handler para o botão de gerenciar
    document.querySelectorAll('.manage-extractor-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            loadExtractorModal(userId);
        });
    });
});

function loadUserExtractorInfo(userId) {
    fetch(`{% url 'core:get_user_extractor_info' 0 %}`.replace('0', userId))
        .then(response => response.json())
        .then(data => {
            updateUserRow(userId, data);
        })
        .catch(error => {
            console.error('Erro ao carregar informações:', error);
            document.querySelector(`.extractor-status[data-user-id="${userId}"]`).innerHTML = 
                '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> Erro</span>';
        });
}

function updateUserRow(userId, data) {
    const statusCell = document.querySelector(`.extractor-status[data-user-id="${userId}"]`);
    const agencyCell = document.querySelector(`.extractor-agency[data-user-id="${userId}"]`);
    const unitsCell = document.querySelector(`.extractor-units[data-user-id="${userId}"]`);
    
    if (data.is_extractor && data.extractors.length > 0) {
        const extractor = data.extractors[0];
        statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check"></i> Sim</span>';
        agencyCell.innerHTML = `<span class="badge bg-info">${extractor.agency_acronym}</span>`;
        
        if (extractor.units.length > 0) {
            const unitsHtml = extractor.units.map(unit => 
                `<span class="badge bg-secondary me-1">${unit.acronym}</span>`
            ).join('');
            unitsCell.innerHTML = unitsHtml;
        } else {
            unitsCell.innerHTML = '<span class="text-muted">Nenhuma unidade associada</span>';
        }
    } else {
        statusCell.innerHTML = '<span class="badge bg-secondary"><i class="fas fa-times"></i> Não</span>';
        agencyCell.innerHTML = '<span class="text-muted">-</span>';
        unitsCell.innerHTML = '<span class="text-muted">-</span>';
    }
}


function renderExtractorModal(userId, data) {
    const modalBody = document.getElementById('extractorModalBody');
    const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
    const userName = userRow.querySelector('strong').textContent;
    
    let html = `
        <div class="mb-3">
            <h6><i class="fas fa-user me-2"></i>${userName}</h6>
        </div>
        
        <div class="mb-4">
            <h6 class="mb-3">Definir como Extrator</h6>
            <div class="mb-3">
                <label class="form-label">Agência de Extração</label>
                <select class="form-select" id="agencySelect">
                    <option value="">Selecione uma agência...</option>
                    {% for agency in agencies %}
                    <option value="{{ agency.pk }}">{{ agency.acronym }} - {{ agency.name }}</option>
                    {% endfor %}
                </select>
            </div>
    `;
    
    if (data.is_extractor && data.extractors.length > 0) {
        const extractor = data.extractors[0];
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Este usuário já é extrator da agência <strong>${extractor.agency_acronym}</strong>.
            </div>
            <button type="button" class="btn btn-danger" onclick="toggleExtractor(${userId}, ${extractor.agency_id}, false)">
                <i class="fas fa-user-times me-2"></i>Remover como Extrator
            </button>
        `;
    } else {
        html += `
            <button type="button" class="btn btn-success" onclick="toggleExtractor(${userId}, null, true)">
                <i class="fas fa-user-plus me-2"></i>Adicionar como Extrator
            </button>
        `;
    }
    
    if (data.is_extractor && data.extractors.length > 0) {
        const extractor = data.extractors[0];
        html += `
            <hr>
            <h6 class="mb-3">Unidades de Extração Associadas</h6>
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">Unidades disponíveis</label>
                    <button type="button" 
                            class="btn btn-sm btn-primary"
                            onclick="associateAllUnits(${extractor.id})"
                            title="Associar a todas as unidades da agência">
                        <i class="fas fa-check-double me-1"></i>
                        Associar a Todas
                    </button>
                </div>
                <div class="list-group" style="max-height: 300px; overflow-y: auto;">
        `;
        
        const associatedUnitIds = extractor.units.map(u => u.id);
        const unitsData = [
            {% for unit in units %}
            {
                id: {{ unit.pk }},
                acronym: '{{ unit.acronym|escapejs }}',
                name: '{{ unit.name|escapejs }}',
                agency_id: {{ unit.agency.pk }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        unitsData.forEach(unit => {
            if (unit.agency_id === extractor.agency_id) {
                const isAssociated = associatedUnitIds.includes(unit.id);
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${unit.acronym}</strong> - ${unit.name}
                        </div>
                        <button type="button" 
                                class="btn btn-sm ${isAssociated ? 'btn-danger' : 'btn-success'}"
                                onclick="toggleUnitAssociation(${extractor.id}, ${unit.id}, ${isAssociated})">
                            <i class="fas fa-${isAssociated ? 'times' : 'plus'}"></i>
                            ${isAssociated ? 'Remover' : 'Associar'}
                        </button>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
        
        if (extractor.units.length > 0) {
            html += `
                <div class="alert alert-info">
                    <strong>Unidades associadas:</strong><br>
                    ${extractor.units.map(u => `<span class="badge bg-secondary me-1">${u.acronym}</span>`).join('')}
                </div>
            `;
        }
    }
    
    html += `</div>`;
    modalBody.innerHTML = html;
}

function toggleExtractor(userId, agencyId, isAdding) {
    if (isAdding) {
        const agencySelect = document.getElementById('agencySelect');
        agencyId = agencySelect.value;
        
        if (!agencyId) {
            alert('Por favor, selecione uma agência.');
            return;
        }
    }
    
    const formData = new FormData();
    if (agencyId) {
        formData.append('agency_id', agencyId);
    }
    
    fetch(`{% url 'core:toggle_extractor' 0 %}`.replace('0', userId), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadUserExtractorInfo(userId);
            // Recarrega o modal após um pequeno delay para garantir que os dados foram atualizados
            setTimeout(() => {
                loadExtractorModal(userId);
            }, 300);
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao processar solicitação.', 'error');
    });
}

// Variável global para armazenar o userId atual do modal
let currentModalUserId = null;

function loadExtractorModal(userId) {
    currentModalUserId = userId;
    const modalBody = document.getElementById('extractorModalBody');
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Carregando...</p>
        </div>
    `;
    
    fetch(`{% url 'core:get_user_extractor_info' 0 %}`.replace('0', userId))
        .then(response => response.json())
        .then(data => {
            renderExtractorModal(userId, data);
        })
        .catch(error => {
            console.error('Erro ao carregar modal:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Erro ao carregar informações do usuário.
                </div>
            `;
        });
}

function toggleUnitAssociation(extractorUserId, unitId, isRemoving) {
    const formData = new FormData();
    formData.append('unit_id', unitId);
    
    fetch(`{% url 'core:toggle_unit_association' 0 %}`.replace('0', extractorUserId), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recarrega as informações do usuário usando o userId armazenado
            if (currentModalUserId) {
                loadUserExtractorInfo(currentModalUserId);
                // Recarrega o modal após um pequeno delay
                setTimeout(() => {
                    loadExtractorModal(currentModalUserId);
                }, 300);
            }
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao processar solicitação.', 'error');
    });
}

function associateAllUnits(extractorUserId) {
    if (!confirm('Deseja associar este extrator a todas as unidades da agência?')) {
        return;
    }
    
    fetch(`{% url 'core:associate_all_units' 0 %}`.replace('0', extractorUserId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recarrega as informações do usuário usando o userId armazenado
            if (currentModalUserId) {
                loadUserExtractorInfo(currentModalUserId);
                // Recarrega o modal após um pequeno delay
                setTimeout(() => {
                    loadExtractorModal(currentModalUserId);
                }, 300);
            }
            showMessage(data.message, 'success');
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showMessage('Erro ao processar solicitação.', 'error');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showMessage(message, type) {
    // Usa o sistema de mensagens do Django se disponível
    // Caso contrário, mostra um alerta simples
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas ${icon} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const modalBody = document.getElementById('extractorModalBody');
    modalBody.insertBefore(alertDiv, modalBody.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}

