<div class="kanban-card" data-extraction-id="{{ extraction.pk }}">
    <div class="card h-100 shadow-sm border-start border-4 border-{{ extraction.get_status_color }} hover-shadow mb-2">
        <div class="card-body p-3">
            <!-- Barra de Progresso Simples -->
            <div class="extraction-progress mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted fw-bold">Progresso</small>
                    <small class="text-muted">
                        {% if extraction.status == 'pending' %}
                            <span class="badge bg-info">0%</span>
                        {% elif extraction.status == 'assigned' %}
                            <span class="badge bg-warning">25%</span>
                        {% elif extraction.status == 'in_progress' %}
                            <span class="badge bg-primary">50%</span>
                        {% elif extraction.status == 'paused' %}
                            <span class="badge bg-secondary">50%</span>
                        {% elif extraction.status == 'completed' %}
                            <span class="badge bg-success">100%</span>
                        {% endif %}
                    </small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar 
                        {% if extraction.status == 'pending' %}bg-info{% elif extraction.status == 'assigned' %}bg-warning{% elif extraction.status == 'in_progress' %}bg-primary{% elif extraction.status == 'paused' %}bg-secondary{% elif extraction.status == 'completed' %}bg-success{% endif %}" 
                        role="progressbar" 
                        style="width: {% if extraction.status == 'pending' %}0{% elif extraction.status == 'assigned' %}25{% elif extraction.status == 'in_progress' or extraction.status == 'paused' %}50{% elif extraction.status == 'completed' %}100{% endif %}%"
                        aria-valuenow="{% if extraction.status == 'pending' %}0{% elif extraction.status == 'assigned' %}25{% elif extraction.status == 'in_progress' or extraction.status == 'paused' %}50{% elif extraction.status == 'completed' %}100{% endif %}" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted" style="font-size: 0.65rem;">
                        {% if extraction.assigned_at %}
                            <i class="fas fa-user-check me-1"></i>{{ extraction.assigned_at|date:"d/m" }}
                        {% elif extraction.status == 'pending' %}
                            <span class="text-muted">Aguardando</span>
                        {% endif %}
                    </small>
                    <small class="text-muted" style="font-size: 0.65rem;">
                        {% if extraction.started_at %}
                            <i class="fas fa-play me-1"></i>{{ extraction.started_at|date:"d/m" }}
                        {% endif %}
                    </small>
                    <small class="text-muted" style="font-size: 0.65rem;">
                        {% if extraction.finished_at %}
                            <i class="fas fa-check me-1"></i>{{ extraction.finished_at|date:"d/m" }}
                        {% endif %}
                    </small>
                </div>
            </div>
            
            <!-- Primeira Linha: Dados do Caso e Ações -->
            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <div class="flex-grow-1">
                    <small class="text-muted">
                        <i class="fas fa-folder-open me-1"></i>
                        <strong>Processo:</strong>
                        <a href="{% url 'cases:detail' extraction.case_device.case.pk %}" class="text-decoration-none">
                            {{ extraction.case_device.case.number|default:"Rascunho" }}
                        </a>
                    </small>
                </div>
                <div class="d-flex gap-1">
                    <button type="button" 
                            class="btn btn-sm btn-outline-primary" 
                            title="Editar Dispositivo"
                            data-bs-toggle="modal" 
                            data-bs-target="#editDeviceModal{{ extraction.case_device.pk }}"
                            data-device-id="{{ extraction.case_device.pk }}"
                            data-case-id="{{ extraction.case_device.case.pk }}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <a href="{% url 'cases:detail' extraction.case_device.case.pk %}" 
                       class="btn btn-sm btn-outline-info" 
                       title="Ver Processo">
                        <i class="fas fa-folder-open"></i>
                    </a>
                </div>
            </div>
            
            <!-- Segunda Linha: ID e Dispositivo -->
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1">
                    <h6 class="card-title mb-1">
                        <strong class="text-primary">#{{ extraction.pk }}</strong>
                    </h6>
                    {% if extraction.case_device.device_model %}
                        <p class="mb-0 small text-muted">
                            <i class="fas fa-mobile-alt me-1"></i>
                            <strong>{{ extraction.case_device.device_model.brand.name }}</strong> {{ extraction.case_device.device_model.name }}
                        </p>
                    {% endif %}
                </div>
                {% if extraction.started_at %}
                    <small class="text-muted text-nowrap ms-2">
                        <i class="fas fa-clock me-1"></i>{{ extraction.started_at|date:"d/m H:i" }}
                    </small>
                {% endif %}
            </div>
            
            <!-- Informações do Dispositivo -->
            {% if extraction.case_device.imei_01 %}
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="fas fa-fingerprint me-1"></i><strong>IMEI:</strong> {{ extraction.case_device.imei_01 }}
                    </small>
                </div>
            {% endif %}
            
            <!-- Status e Ações -->
            <div class="border-top pt-2 mt-2">
                {% if extraction.status == 'pending' %}
                    <div class="mb-2">
                        <button type="button" 
                                class="btn btn-primary btn-sm w-100" 
                                title="Iniciar Extração"
                                data-bs-toggle="modal" 
                                data-bs-target="#startModal{{ extraction.pk }}">
                            <i class="fas fa-play me-2"></i>Iniciar Extração
                        </button>
                    </div>
                {% elif extraction.status == 'assigned' %}
                    <div class="mb-2">
                        <button type="button" 
                                class="btn btn-primary btn-sm w-100" 
                                title="Iniciar Extração"
                                data-bs-toggle="modal" 
                                data-bs-target="#startModal{{ extraction.pk }}">
                            <i class="fas fa-play me-2"></i>Iniciar Extração
                        </button>
                    </div>
                    {% if not extraction.started_at %}
                        <form method="post" action="{% url 'extractions:unassign_from_me' extraction.pk %}" class="ajax-form">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="btn btn-outline-danger btn-sm w-100" 
                                    title="Desatribuir-me"
                                    onclick="return confirm('Tem certeza que deseja se desatribuir desta extração?');">
                                <i class="fas fa-user-times me-2"></i>Desatribuir-me
                            </button>
                        </form>
                    {% endif %}
                {% elif extraction.status == 'in_progress' %}
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                        <div class="d-flex flex-wrap gap-1">
                            {% if extraction.assigned_to and extraction.assigned_to.user == request.user %}
                                {% if not extraction.brute_force_started_at %}
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger" 
                                            title="Iniciar Força Bruta"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#startBruteForceModal{{ extraction.pk }}">
                                        <i class="fas fa-unlock-alt"></i>
                                    </button>
                                {% elif extraction.brute_force_started_at and not extraction.brute_force_finished_at %}
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger" 
                                            title="Finalizar Força Bruta"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#finishBruteForceModal{{ extraction.pk }}"
                                            data-extraction-id="{{ extraction.pk }}">
                                        <i class="fas fa-unlock"></i>
                                    </button>
                                {% endif %}
                            {% endif %}
                            <button type="button" 
                                    class="btn btn-sm btn-outline-warning" 
                                    title="Pausar Extração"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#pauseModal{{ extraction.pk }}">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary" 
                                    title="Cancelar Extração"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#cancelExtractionModal{{ extraction.pk }}">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-success" 
                                    title="Finalizar Extração"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#finishExtractionModal{{ extraction.pk }}"
                                    data-extraction-id="{{ extraction.pk }}">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                    {% if extraction.brute_force_started_at and not extraction.brute_force_finished_at %}
                        <div class="alert alert-danger py-1 px-2 mb-0 small">
                            <i class="fas fa-unlock-alt me-1"></i><strong>Força Bruta Ativa</strong>
                        </div>
                    {% endif %}
                {% elif extraction.status == 'paused' %}
                    <div class="mb-2">
                        <button type="button" 
                                class="btn btn-primary btn-sm w-100" 
                                title="Iniciar Extração"
                                data-bs-toggle="modal" 
                                data-bs-target="#startModal{{ extraction.pk }}">
                            <i class="fas fa-play me-2"></i>Iniciar Extração
                        </button>
                    </div>
                    <div class="d-flex flex-wrap gap-1 mb-2">
                        <button type="button" 
                                class="btn btn-sm btn-outline-success" 
                                title="Retomar Extração"
                                data-bs-toggle="modal" 
                                data-bs-target="#resumeModal{{ extraction.pk }}">
                            <i class="fas fa-play"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-success" 
                                title="Finalizar Extração"
                                data-bs-toggle="modal" 
                                data-bs-target="#finishExtractionModal{{ extraction.pk }}"
                                data-extraction-id="{{ extraction.pk }}">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                    {% if extraction.paused_notes %}
                        <div class="alert alert-secondary py-1 px-2 mb-0 small">
                            <i class="fas fa-sticky-note me-1"></i>{{ extraction.paused_notes|truncatewords:5 }}
                        </div>
                    {% endif %}
                {% elif extraction.status == 'completed' %}
                    <div class="mb-2">
                        {% if extraction.extraction_result %}
                            {% if extraction.extraction_result == 'success' %}
                                <span class="badge bg-success">✓ Sucesso</span>
                            {% elif extraction.extraction_result == 'failed' %}
                                <span class="badge bg-danger">✗ Falhou</span>
                            {% elif extraction.extraction_result == 'partial' %}
                                <span class="badge bg-warning">~ Parcial</span>
                            {% endif %}
                        {% endif %}
                        {% if extraction.finished_at %}
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-calendar-alt me-1"></i>{{ extraction.finished_at|date:"d/m/Y H:i" }}
                            </small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            
        </div>
    </div>
</div>

<style>
.kanban-card {
    margin-bottom: 0;
}

.kanban-card .card {
    transition: all 0.2s ease;
}

.kanban-card .card:hover {
    transform: translateY(-2px);
}

.hover-shadow {
    transition: box-shadow 0.2s ease;
}

.hover-shadow:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}

/* Barra de Progresso Simples */
.extraction-progress {
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.extraction-progress .progress {
    border-radius: 3px;
    background-color: #e9ecef;
}

.extraction-progress .progress-bar {
    transition: width 0.6s ease;
}
</style>

